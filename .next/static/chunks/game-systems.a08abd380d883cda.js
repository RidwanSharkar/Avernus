"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[893],{5050:function(t,e,i){i.d(e,{Ge:function(){return r},g3:function(){return o},j4:function(){return n}});let s=0,a=0;function n(t){s=t}function r(t){a=t}function o(t){let e=Math.random()<.11+.03*s,i=2+.15*a;return{damage:Math.floor(e?t*i:t),isCritical:e}}},45:function(t,e,i){i.d(e,{D:function(){return o}});var s=i(4058),a=i(948);class n extends a.v{start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),this.accumulator=0,this.frameId=requestAnimationFrame(this.gameLoop.bind(this)))}stop(){this.isRunning&&(this.isRunning=!1,this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=0))}getCurrentFPS(){return this.currentFPS}getFixedTimeStep(){return this.fixedTimeStep}gameLoop(t){if(!this.isRunning)return;let e=Math.min((t-this.lastTime)/1e3,this.maxFrameTime);this.lastTime=t,this.currentTime=t,this.updateFPS(e),this.accumulator+=e;let i=0;for(;this.accumulator>=this.fixedTimeStep&&i<this.maxSubSteps;)this.emit("fixedUpdate",{fixedDeltaTime:this.fixedTimeStep}),this.accumulator-=this.fixedTimeStep,i++;this.emit("update",{deltaTime:e});let s=this.accumulator/this.fixedTimeStep;this.emit("render",{deltaTime:e,interpolation:s}),this.frameId=requestAnimationFrame(this.gameLoop.bind(this))}updateFPS(t){this.frameCount++,this.fpsUpdateTime+=t,this.fpsUpdateTime>=1&&(this.currentFPS=Math.round(this.frameCount/this.fpsUpdateTime),this.frameCount=0,this.fpsUpdateTime=0)}pause(){this.isRunning&&this.stop()}resume(){this.isRunning||this.start()}isPaused(){return!this.isRunning}getCurrentTime(){return this.currentTime}getInterpolationRatio(){return this.accumulator/this.fixedTimeStep}constructor(){super(),this.isRunning=!1,this.lastTime=0,this.accumulator=0,this.currentTime=0,this.frameId=0,this.fixedTimeStep=1/60,this.maxFrameTime=1/30,this.maxSubSteps=5,this.frameCount=0,this.fpsUpdateTime=0,this.currentFPS=0}}class r extends a.v{initialize(t){this.canvas=t,t.addEventListener("mousedown",this.onMouseDown.bind(this)),t.addEventListener("mouseup",this.onMouseUp.bind(this)),t.addEventListener("mousemove",this.onMouseMove.bind(this)),t.addEventListener("wheel",this.onWheel.bind(this),{passive:!1}),t.addEventListener("contextmenu",t=>t.preventDefault())}requestPointerLock(){this.canvas&&this.canvas.requestPointerLock()}exitPointerLock(){document.exitPointerLock()}isKeyPressed(t){return this.keys.has(t.toLowerCase())}isMouseButtonPressed(t){return this.mouseButtons.has(t)}getMousePosition(){return{...this.mousePosition}}getMouseDelta(){return{...this.mouseDelta}}getInputState(){return{keys:new Set(this.keys),mouse:{x:this.mousePosition.x,y:this.mousePosition.y,deltaX:this.mouseDelta.x,deltaY:this.mouseDelta.y,buttons:new Set(this.mouseButtons)}}}checkDoubleTap(t){let e=t.toLowerCase(),i=this.keyTimings.get(e);return!!i&&(Date.now(),!!i.hasValidFirstTap&&!!i.isInDoubleTapSequence&&i.secondPressTime>0&&i.secondPressTime-i.firstReleaseTime<=this.DOUBLE_TAP_THRESHOLD)}resetDoubleTap(t){let e=t.toLowerCase(),i=this.keyTimings.get(e);i&&(i.firstPressTime=0,i.firstReleaseTime=0,i.secondPressTime=0,i.isInDoubleTapSequence=!1,i.hasValidFirstTap=!1)}update(){this.mouseDelta.x=0,this.mouseDelta.y=0,this.cleanupOldTimings()}cleanupOldTimings(){let t=Date.now(),e=[];this.keyTimings.forEach((i,s)=>{let a=Math.max(i.firstPressTime,i.firstReleaseTime,i.secondPressTime);a>0&&t-a>5e3&&e.push(s)}),e.forEach(t=>this.keyTimings.delete(t))}getDoubleTapDebugInfo(t){let e=t.toLowerCase(),i=this.keyTimings.get(e);if(!i)return null;let s=Date.now();return{key:e,firstPressTime:i.firstPressTime,firstReleaseTime:i.firstReleaseTime,secondPressTime:i.secondPressTime,hasValidFirstTap:i.hasValidFirstTap,isInDoubleTapSequence:i.isInDoubleTapSequence,timeSinceFirstPress:i.firstPressTime>0?s-i.firstPressTime:0,timeSinceFirstRelease:i.firstReleaseTime>0?s-i.firstReleaseTime:0,timeSinceSecondPress:i.secondPressTime>0?s-i.secondPressTime:0,threshold:this.DOUBLE_TAP_THRESHOLD}}setupEventListeners(){document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this)),document.addEventListener("mousedown",this.onMouseDown.bind(this)),document.addEventListener("mouseup",this.onMouseUp.bind(this)),document.addEventListener("mousemove",this.onMouseMove.bind(this)),document.addEventListener("wheel",this.onWheel.bind(this),{passive:!1}),document.addEventListener("pointerlockchange",this.onPointerLockChange.bind(this)),document.addEventListener("pointerlockerror",this.onPointerLockError.bind(this)),document.addEventListener("contextmenu",t=>t.preventDefault()),window.addEventListener("blur",this.onWindowBlur.bind(this)),window.addEventListener("focus",this.onWindowFocus.bind(this))}onKeyDown(t){let e=t.key.toLowerCase();if(!this.keys.has(e)){this.keys.add(e),this.emit("keyDown",{key:t.key,code:t.code});let i=Date.now(),s=this.keyTimings.get(e);s||(s={firstPressTime:0,firstReleaseTime:0,secondPressTime:0,isInDoubleTapSequence:!1,hasValidFirstTap:!1},this.keyTimings.set(e,s)),s.hasValidFirstTap?s.hasValidFirstTap&&!s.isInDoubleTapSequence&&(i-s.firstReleaseTime<=this.DOUBLE_TAP_THRESHOLD?(s.secondPressTime=i,s.isInDoubleTapSequence=!0):(s.firstPressTime=i,s.firstReleaseTime=0,s.secondPressTime=0,s.isInDoubleTapSequence=!1,s.hasValidFirstTap=!1)):(s.firstPressTime=i,s.isInDoubleTapSequence=!1,s.hasValidFirstTap=!1)}this.isGameKey(e)&&t.preventDefault()}onKeyUp(t){let e=t.key.toLowerCase();if(this.keys.has(e)){this.keys.delete(e),this.emit("keyUp",{key:t.key,code:t.code});let i=this.keyTimings.get(e);if(i){let t=Date.now();!i.hasValidFirstTap&&i.firstPressTime>0?(i.firstReleaseTime=t,i.hasValidFirstTap=!0):i.isInDoubleTapSequence&&setTimeout(()=>{i&&(i.firstPressTime=0,i.firstReleaseTime=0,i.secondPressTime=0,i.isInDoubleTapSequence=!1,i.hasValidFirstTap=!1)},100)}}}onMouseDown(t){this.mouseButtons.add(t.button),this.emit("mouseDown",{button:t.button,x:t.clientX,y:t.clientY})}onMouseUp(t){this.mouseButtons.delete(t.button),this.emit("mouseUp",{button:t.button,x:t.clientX,y:t.clientY})}onMouseMove(t){if(this.isPointerLocked)this.mouseDelta.x+=t.movementX,this.mouseDelta.y+=t.movementY;else{this.previousMousePosition.x=this.mousePosition.x,this.previousMousePosition.y=this.mousePosition.y,this.mousePosition.x=t.clientX,this.mousePosition.y=t.clientY;let e=this.mousePosition.x-this.previousMousePosition.x,i=this.mousePosition.y-this.previousMousePosition.y;this.mouseDelta.x+=e,this.mouseDelta.y+=i}this.emit("mouseMove",{x:this.mousePosition.x,y:this.mousePosition.y,deltaX:this.mouseDelta.x,deltaY:this.mouseDelta.y})}onWheel(t){this.emit("wheel",{deltaX:t.deltaX,deltaY:t.deltaY,deltaZ:t.deltaZ}),t.preventDefault()}onPointerLockChange(){this.isPointerLocked=null!==document.pointerLockElement}onPointerLockError(){this.isPointerLocked=!1}onWindowBlur(){this.keys.clear(),this.mouseButtons.clear(),this.keyTimings.clear()}onWindowFocus(){this.mouseDelta.x=0,this.mouseDelta.y=0}isGameKey(t){return["w","a","s","d"," ","shift","tab","escape"].includes(t)}destroy(){document.removeEventListener("keydown",this.onKeyDown.bind(this)),document.removeEventListener("keyup",this.onKeyUp.bind(this)),document.removeEventListener("mousedown",this.onMouseDown.bind(this)),document.removeEventListener("mouseup",this.onMouseUp.bind(this)),document.removeEventListener("mousemove",this.onMouseMove.bind(this)),document.removeEventListener("wheel",this.onWheel.bind(this)),document.removeEventListener("pointerlockchange",this.onPointerLockChange.bind(this)),document.removeEventListener("pointerlockerror",this.onPointerLockError.bind(this)),window.removeEventListener("blur",this.onWindowBlur.bind(this)),window.removeEventListener("focus",this.onWindowFocus.bind(this)),this.canvas&&(this.canvas.removeEventListener("mousedown",this.onMouseDown.bind(this)),this.canvas.removeEventListener("mouseup",this.onMouseUp.bind(this)),this.canvas.removeEventListener("mousemove",this.onMouseMove.bind(this)),this.canvas.removeEventListener("wheel",this.onWheel.bind(this))),this.keys.clear(),this.mouseButtons.clear(),this.keyTimings.clear(),this.removeAllListeners()}constructor(){super(),this.keys=new Set,this.mouseButtons=new Set,this.mousePosition={x:0,y:0},this.mouseDelta={x:0,y:0},this.previousMousePosition={x:0,y:0},this.isPointerLocked=!1,this.canvas=null,this.keyTimings=new Map,this.DOUBLE_TAP_THRESHOLD=200,this.setupEventListeners()}}class o extends a.v{async initialize(t){this.isInitialized||(this.canvas=t,this.inputManager.initialize(t),this.isInitialized=!0,this.emit("initialized"))}start(){if(!this.isInitialized)throw Error("Engine must be initialized before starting");this.isRunning||(this.isRunning=!0,this.gameLoop.start(),this.emit("started"))}stop(){this.isRunning&&(this.isRunning=!1,this.gameLoop.stop(),this.emit("stopped"))}pause(){this.isRunning&&(this.gameLoop.pause(),this.emit("paused"))}resume(){this.isRunning&&(this.gameLoop.resume(),this.emit("resumed"))}getWorld(){return this.world}getInputManager(){return this.inputManager}getCanvas(){return this.canvas}isEngineRunning(){return this.isRunning}getCurrentFPS(){return this.gameLoop.getCurrentFPS()}getPerformanceStats(){return{fps:this.gameLoop.getCurrentFPS(),frameTime:this.frameTime,updateTime:this.updateTime,renderTime:this.renderTime}}enableDebugMode(t){this.debugMode=t}isDebugMode(){return this.debugMode}setupGameLoop(){this.gameLoop.on("fixedUpdate",t=>{let{fixedDeltaTime:e}=t,i=performance.now();this.world.fixedUpdate(e),this.debugMode&&(this.updateTime=performance.now()-i)}),this.gameLoop.on("update",t=>{let{deltaTime:e}=t,i=performance.now();this.world.update(e),this.inputManager.update(),this.debugMode&&(this.updateTime=performance.now()-i),this.emit("update",{deltaTime:e})}),this.gameLoop.on("render",t=>{let{deltaTime:e,interpolation:i}=t,s=performance.now();this.world.render(e),this.debugMode&&(this.renderTime=performance.now()-s,this.frameTime=this.updateTime+this.renderTime),this.emit("render",{deltaTime:e,interpolation:i})})}destroy(){this.stop(),this.world.destroy(),this.inputManager.destroy(),this.removeAllListeners(),this.isInitialized=!1}requestPointerLock(){this.inputManager.requestPointerLock()}exitPointerLock(){this.inputManager.exitPointerLock()}isKeyPressed(t){return this.inputManager.isKeyPressed(t)}isMouseButtonPressed(t){return this.inputManager.isMouseButtonPressed(t)}getMouseDelta(){return this.inputManager.getMouseDelta()}constructor(t={}){super(),this.canvas=null,this.isInitialized=!1,this.isRunning=!1,this.debugMode=!1,this.frameTime=0,this.updateTime=0,this.renderTime=0,this.world=new s.q,this.gameLoop=new n,this.inputManager=new r,this.debugMode=t.enableDebug||!1,this.setupGameLoop()}}},3980:function(t,e,i){i.d(e,{J:function(){return s},w:function(){return a}});class s{addComponent(t){let e=t.componentType||t.constructor.name;return this.components.set(e,t),t}removeComponent(t){this.components.delete(t.name)}getComponent(t){let e=t.componentType||t.name,i=this.components.get(e);if(!i&&t.componentType&&(i=this.components.get(t.name)),!i&&t){for(let[e,s]of Array.from(this.components.entries()))if(s instanceof t){i=s;break}}return i&&(i.componentType||i.constructor.name)!==e&&i.constructor.name.match(/^[a-z]$/),i}hasComponent(t){let e=t.componentType||t.name;if(this.components.has(e)||t.componentType&&this.components.has(t.name))return!0;if(t){for(let e of Array.from(this.components.values()))if(e instanceof t)return!0}return!1}hasComponents(t){return t.every(t=>this.hasComponent(t))}getAllComponents(){return Array.from(this.components.values())}getComponentNames(){return Array.from(this.components.keys())}isActive(){return this.active}setActive(t){this.active=t}destroy(){this.components.clear(),this.active=!1}constructor(){this.components=new Map,this.active=!0,this.id=s.nextId++}}s.nextId=1;class a{constructor(){this.enabled=!0}}},9131:function(t,e,i){i.d(e,{FU:function(){return n},Kg:function(){return a},xP:function(){return s}});class s{matchesEntity(t){return t.isActive()&&t.hasComponents(this.requiredComponents)}constructor(){this.enabled=!0,this.priority=0}}class a extends s{}class n extends s{}},4058:function(t,e,i){i.d(e,{q:function(){return r}});var s=i(3980),a=i(9131),n=i(6520);class r{createEntity(){let t=new s.J;return this.entities.set(t.id,t),t}destroyEntity(t){this.entitiesToDestroy.push(t)}notifyEntityAdded(t){for(let e of this.systems)e.onEntityAdded&&e.matchesEntity(t)&&e.onEntityAdded(t)}getEntity(t){return this.entities.get(t)}getAllEntities(){return Array.from(this.entities.values())}addSystem(t){var e;this.systems.push(t),this.systems.sort((t,e)=>t.priority-e.priority),t instanceof a.Kg&&this.renderSystems.push(t),t instanceof a.FU&&this.physicsSystems.push(t),null===(e=t.onEnable)||void 0===e||e.call(t)}getSystem(t){return this.systems.find(e=>e instanceof t)}removeSystem(t){let e=this.systems.findIndex(e=>e instanceof t);if(-1!==e){var i;let t=this.systems[e];null===(i=t.onDisable)||void 0===i||i.call(t),this.systems.splice(e,1);let s=this.renderSystems.findIndex(e=>e===t);-1!==s&&this.renderSystems.splice(s,1);let a=this.physicsSystems.findIndex(e=>e===t);-1!==a&&this.physicsSystems.splice(a,1)}}createComponent(t){let e=t.componentType||t.name;if(["Health","HealthBar","Transform","Movement","Collider","Renderer","Enemy","Projectile","Animation"].includes(e))return new t;let i=this.componentPools.get(e);return i||(i=new n.L(()=>new t,t=>t.reset(),100),this.componentPools.set(e,i)),i.acquire()}returnComponent(t){let e=this.componentPools.get(t.constructor.name);e&&e.release(t)}update(t){for(let e of(this.cleanupDestroyedEntities(),this.systems)){if(!e.enabled)continue;let i=this.getEntitiesForSystem(e);e.update(i,t)}}fixedUpdate(t){for(let e of this.physicsSystems){if(!e.enabled)continue;let i=this.getEntitiesForSystem(e);e.fixedUpdate(i,t)}}render(t){for(let e of this.renderSystems){if(!e.enabled)continue;let i=this.getEntitiesForSystem(e);e.render(i,t)}}getEntitiesForSystem(t){let e=[];for(let i of Array.from(this.entities.values()))t.matchesEntity(i)&&e.push(i);return e}cleanupDestroyedEntities(){for(let t of this.entitiesToDestroy){let e=this.entities.get(t);if(e){for(let t of this.systems)t.onEntityRemoved&&t.matchesEntity(e)&&t.onEntityRemoved(e);for(let t of e.getAllComponents())this.returnComponent(t);e.destroy(),this.entities.delete(t)}}this.entitiesToDestroy.length=0}queryEntities(t){let e=[];for(let i of Array.from(this.entities.values()))i.isActive()&&i.hasComponents(t)&&e.push(i);return e}emitEvent(t,e){this.events.has(t)||this.events.set(t,[]),this.events.get(t).push(e)}getEvents(t){return this.events.get(t)||[]}clearEvents(t){this.events.set(t,[])}destroy(){for(let t of Array.from(this.entities.values()))t.destroy();for(let e of(this.entities.clear(),this.systems)){var t;null===(t=e.onDisable)||void 0===t||t.call(e)}this.systems.length=0,this.renderSystems.length=0,this.physicsSystems.length=0,this.componentPools.clear(),this.events.clear()}constructor(){this.entities=new Map,this.systems=[],this.renderSystems=[],this.physicsSystems=[],this.componentPools=new Map,this.entitiesToDestroy=[],this.events=new Map}}},3478:function(t,e,i){i.d(e,{F5:function(){return n},YM:function(){return l},aB:function(){return r}});var s,a,n,r,o=i(1448),h=i(3980);(s=n||(n={})).SPHERE="sphere",s.BOX="box",s.CAPSULE="capsule",s.CYLINDER="cylinder",(a=r||(r={}))[a.DEFAULT=1]="DEFAULT",a[a.PLAYER=2]="PLAYER",a[a.ENEMY=4]="ENEMY",a[a.PROJECTILE=8]="PROJECTILE",a[a.ENVIRONMENT=16]="ENVIRONMENT",a[a.PICKUP=32]="PICKUP";class l extends h.w{getDefaultMask(t){switch(t){case 2:return 52;case 4:return 26;case 8:return 22;case 16:return 14;case 32:return 2;default:return 4294967295}}static createSphere(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return new l("sphere",t,e)}static createBox(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=new l("box",0,e);return i.size.copy(t),i}static createCapsule(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,s=new l("capsule",t,i);return s.height=e,s}static createCylinder(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,s=new l("cylinder",t,i);return s.height=e,s}setOffset(t,e,i){this.offset.set(t,e,i),this.boundsNeedUpdate=!0}setLayer(t){this.layer=t,this.mask=this.getDefaultMask(t)}setMask(t){this.mask=t}canCollideWith(t){return(this.mask&t.layer)!=0&&(t.mask&this.layer)!=0}updateBounds(t){if(!this.boundsNeedUpdate&&!this.isStatic)return;let e=t.clone().add(this.offset);switch(this.type){case"sphere":this.boundingSphere.set(e,this.radius),this.bounds.setFromCenterAndSize(e,new o.Vector3(2*this.radius,2*this.radius,2*this.radius));break;case"box":this.bounds.setFromCenterAndSize(e,this.size),this.boundingSphere.setFromPoints([e.clone().add(new o.Vector3(-this.size.x/2,-this.size.y/2,-this.size.z/2)),e.clone().add(new o.Vector3(this.size.x/2,this.size.y/2,this.size.z/2))]);break;case"capsule":let i=Math.max(this.radius,this.size.x/2,this.size.z/2);this.boundingSphere.set(e,Math.max(i,this.height/2)),this.bounds.setFromCenterAndSize(e,new o.Vector3(2*i,this.height,2*i));break;case"cylinder":this.boundingSphere.set(e,Math.max(this.radius,this.height/2)),this.bounds.setFromCenterAndSize(e,new o.Vector3(2*this.radius,this.height,2*this.radius))}this.boundsNeedUpdate=!1}intersects(t,e,i){return this.updateBounds(e),t.updateBounds(i),!!this.boundingSphere.intersectsSphere(t.boundingSphere)&&this.preciseIntersection(t,e,i)}preciseIntersection(t,e,i){let s=e.clone().add(this.offset),a=i.clone().add(t.offset);if("sphere"===this.type&&"sphere"===t.type)return s.distanceTo(a)<=this.radius+t.radius;if("box"===this.type&&"box"===t.type)return this.bounds.intersectsBox(t.bounds);if("sphere"===this.type&&"box"===t.type||"box"===this.type&&"sphere"===t.type){let e="sphere"===this.type?this:t,i="box"===this.type?this:t,n="sphere"===this.type?s:a,r=new o.Vector3;return i.bounds.clampPoint(n,r),n.distanceTo(r)<=e.radius}if("sphere"===this.type&&"cylinder"===t.type||"cylinder"===this.type&&"sphere"===t.type){let e="sphere"===this.type?this:t,i="cylinder"===this.type?this:t,n="sphere"===this.type?s:a,r="cylinder"===this.type?s:a;return!(Math.abs(n.y-r.y)>i.height/2+e.radius)&&Math.sqrt(Math.pow(n.x-r.x,2)+Math.pow(n.z-r.z,2))<=e.radius+i.radius}return this.bounds.intersectsBox(t.bounds)}getClosestPoint(t,e){this.updateBounds(e);let i=e.clone().add(this.offset);switch(this.type){case"sphere":let s=t.clone().sub(i).normalize();return i.clone().add(s.multiplyScalar(this.radius));case"box":let a=new o.Vector3;return this.bounds.clampPoint(t,a),a;default:let n=new o.Vector3;return this.bounds.clampPoint(t,n),n}}getVolume(){switch(this.type){case"sphere":return 4/3*Math.PI*Math.pow(this.radius,3);case"box":return this.size.x*this.size.y*this.size.z;case"cylinder":return Math.PI*Math.pow(this.radius,2)*this.height;case"capsule":return 4/3*Math.PI*Math.pow(this.radius,3)+Math.PI*Math.pow(this.radius,2)*(this.height-2*this.radius);default:return 1}}reset(){this.type="sphere",this.radius=.5,this.size.set(1,1,1),this.height=2,this.offset.set(0,0,0),this.layer=1,this.mask=this.getDefaultMask(1),this.isTrigger=!1,this.isStatic=!1,this.bounds=new o.Box3,this.boundingSphere=new o.Sphere,this.boundsNeedUpdate=!0,this.onCollisionEnter=void 0,this.onCollisionStay=void 0,this.onCollisionExit=void 0,this.onTriggerEnter=void 0,this.onTriggerStay=void 0,this.onTriggerExit=void 0,this.enabled=!0}clone(){let t=new l(this.type,this.radius,this.layer);return t.size.copy(this.size),t.height=this.height,t.offset.copy(this.offset),t.mask=this.mask,t.isTrigger=this.isTrigger,t.isStatic=this.isStatic,t}constructor(t="sphere",e=.5,i=1){super(),this.componentType="Collider",this.type=t,this.radius=e,this.size=new o.Vector3(1,1,1),this.height=2,this.offset=new o.Vector3(0,0,0),this.layer=i,this.mask=this.getDefaultMask(i),this.isTrigger=!1,this.isStatic=!1,this.bounds=new o.Box3,this.boundingSphere=new o.Sphere,this.boundsNeedUpdate=!0}}l.componentType="Collider"},8001:function(t,e,i){i.d(e,{C:function(){return r},Z:function(){return a}});var s,a,n=i(3980);(s=a||(a={})).DUMMY="dummy",s.GRUNT="grunt",s.ELITE="elite",s.BOSS="boss";class r extends n.w{calculateExperienceReward(){return({dummy:5,grunt:10,elite:25,boss:100})[this.type]*this.level}calculateAggroRange(){return({dummy:0,grunt:5,elite:8,boss:12})[this.type]}calculateAttackRange(){return({dummy:0,grunt:1.5,elite:2,boss:3})[this.type]}calculateAttackDamage(){return({dummy:0,grunt:15,elite:25,boss:50})[this.type]*this.level}calculateAttackCooldown(){return({dummy:0,grunt:2,elite:1.5,boss:1})[this.type]}calculateMovementSpeed(){return({dummy:0,grunt:3,elite:0,boss:2.5})[this.type]}canAttack(t){return!!this.isAggressive&&!this.isDead&&0!==this.attackDamage&&t-this.lastAttackTime>=this.attackCooldown}performAttack(t){this.lastAttackTime=t}takeDamage(){}die(t){this.isDead=!0,this.deathTime=t}canRespawnNow(t){return!!this.canRespawn&&!!this.isDead&&t-this.deathTime>=this.respawnTime}respawn(){this.isDead=!1,this.deathTime=0,this.lastAttackTime=0,this.unfreeze(),this.removeVenom()}freeze(t,e){this.isDead||(this.isFrozen=!0,this.freezeStartTime=e,this.freezeDuration=t,this.movementSpeed=0)}unfreeze(){this.isFrozen=!1,this.freezeStartTime=0,this.freezeDuration=0,this.movementSpeed=this.originalMovementSpeed}updateFreezeStatus(t){this.isFrozen&&t-this.freezeStartTime>=this.freezeDuration&&this.unfreeze()}canMove(){return!this.isFrozen&&!this.isDead}applyVenom(t,e,i){this.isDead||(this.isVenomous=!0,this.venomStartTime=i,this.venomDuration=t,this.venomDamagePerSecond=e,this.lastVenomDamageTime=i)}removeVenom(){this.isVenomous=!1,this.venomStartTime=0,this.venomDuration=0,this.venomDamagePerSecond=0,this.lastVenomDamageTime=0}updateVenomStatus(t){return this.isVenomous?t-this.venomStartTime>=this.venomDuration?(this.removeVenom(),{shouldDealDamage:!1,damage:0}):t-this.lastVenomDamageTime>=1?(this.lastVenomDamageTime=t,{shouldDealDamage:!0,damage:this.venomDamagePerSecond}):{shouldDealDamage:!1,damage:0}:{shouldDealDamage:!1,damage:0}}applySunderStack(t){this.isDead||(this.sunderStacks>0&&t-this.sunderLastApplied>this.sunderDuration&&(this.sunderStacks=0),this.sunderStacks<3&&this.sunderStacks++,this.sunderLastApplied=t)}getSunderStacks(){return this.sunderStacks}clearSunderStacks(){this.sunderStacks=0,this.sunderLastApplied=0}updateSunderStatus(t){!(this.sunderStacks<=0)&&t-this.sunderLastApplied>=this.sunderDuration&&this.clearSunderStacks()}setLevel(t){this.level=Math.max(1,t),this.experienceReward=this.calculateExperienceReward(),this.attackDamage=this.calculateAttackDamage()}getDisplayName(){return"".concat({dummy:"Training Dummy",grunt:"Grunt",elite:"Elite",boss:"Boss"}[this.type]," (Lv.").concat(this.level,")")}reset(){this.type="dummy",this.level=1,this.experienceReward=this.calculateExperienceReward(),this.isAggressive=!1,this.aggroRange=this.calculateAggroRange(),this.attackRange=this.calculateAttackRange(),this.attackDamage=this.calculateAttackDamage(),this.attackCooldown=this.calculateAttackCooldown(),this.lastAttackTime=0,this.movementSpeed=this.calculateMovementSpeed(),this.isDead=!1,this.deathTime=0,this.respawnTime=30,this.canRespawn=!0,this.enabled=!0,this.isFrozen=!1,this.freezeStartTime=0,this.freezeDuration=0,this.originalMovementSpeed=this.movementSpeed,this.isVenomous=!1,this.venomStartTime=0,this.venomDuration=0,this.venomDamagePerSecond=0,this.lastVenomDamageTime=0,this.sunderStacks=0,this.sunderLastApplied=0}clone(){let t=new r(this.type,this.level);return t.experienceReward=this.experienceReward,t.isAggressive=this.isAggressive,t.aggroRange=this.aggroRange,t.attackRange=this.attackRange,t.attackDamage=this.attackDamage,t.attackCooldown=this.attackCooldown,t.lastAttackTime=this.lastAttackTime,t.movementSpeed=this.movementSpeed,t.isDead=this.isDead,t.deathTime=this.deathTime,t.respawnTime=this.respawnTime,t.canRespawn=this.canRespawn,t.isFrozen=this.isFrozen,t.freezeStartTime=this.freezeStartTime,t.freezeDuration=this.freezeDuration,t.originalMovementSpeed=this.originalMovementSpeed,t.isVenomous=this.isVenomous,t.venomStartTime=this.venomStartTime,t.venomDuration=this.venomDuration,t.venomDamagePerSecond=this.venomDamagePerSecond,t.lastVenomDamageTime=this.lastVenomDamageTime,t.sunderStacks=this.sunderStacks,t.sunderLastApplied=this.sunderLastApplied,t}constructor(t="dummy",e=1){super(),this.componentType="Enemy",this.type=t,this.level=e,this.experienceReward=this.calculateExperienceReward(),this.isAggressive="dummy"!==t,this.aggroRange=this.calculateAggroRange(),this.attackRange=this.calculateAttackRange(),this.attackDamage=this.calculateAttackDamage(),this.attackCooldown=this.calculateAttackCooldown(),this.lastAttackTime=0,this.movementSpeed=this.calculateMovementSpeed(),this.isDead=!1,this.deathTime=0,this.respawnTime=30,this.canRespawn=!0,this.isFrozen=!1,this.freezeStartTime=0,this.freezeDuration=0,this.originalMovementSpeed=this.movementSpeed,this.isVenomous=!1,this.venomStartTime=0,this.venomDuration=0,this.venomDamagePerSecond=0,this.lastVenomDamageTime=0,this.sunderStacks=0,this.sunderLastApplied=0,this.sunderDuration=10}}r.componentType="Enemy"},6862:function(t,e,i){i.d(e,{S:function(){return n}});var s=i(3980),a=i(3974);class n extends s.w{takeDamage(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Date.now()/1e3,i=arguments.length>2?arguments[2]:void 0,s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(this.isDead||!s&&this.isInvulnerable||t<=0)return!1;let n=t;if(i){let e=i.getComponent(a.W);e&&(n=e.absorbDamage(t))}return n>0&&(this.currentHealth=Math.max(0,this.currentHealth-n),this.lastDamageTime=e,this.isInvulnerable=!0,this.invulnerabilityTimer=this.invulnerabilityDuration,this.currentHealth<=0&&(this.isDead=!0)),!0}heal(t){if(this.isDead||t<=0)return!1;let e=this.currentHealth;return this.currentHealth=Math.min(this.maxHealth,this.currentHealth+t),this.currentHealth>e}setMaxHealth(t){let e=this.getHealthRatio();this.maxHealth=Math.max(1,t),this.currentHealth=Math.floor(this.maxHealth*e)}getHealthRatio(){return this.maxHealth>0?this.currentHealth/this.maxHealth:0}getHealthPercentage(){return 100*this.getHealthRatio()}isFullHealth(){return this.currentHealth>=this.maxHealth}isLowHealth(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.25;return this.getHealthRatio()<=t}isCriticalHealth(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1;return this.getHealthRatio()<=t}revive(t){this.isDead=!1,this.currentHealth=void 0!==t?Math.min(this.maxHealth,t):this.maxHealth,this.isInvulnerable=!1,this.invulnerabilityTimer=0}update(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Date.now()/1e3;this.isInvulnerable&&(this.invulnerabilityTimer-=t,this.invulnerabilityTimer<=0&&(this.isInvulnerable=!1,this.invulnerabilityTimer=0)),this.canRegenerate&&!this.isDead&&!this.isFullHealth()&&e-this.lastDamageTime>=this.regenerationDelay&&this.heal(this.regenerationRate*t)}setInvulnerable(t){this.isInvulnerable=!0,this.invulnerabilityTimer=t}removeInvulnerability(){this.isInvulnerable=!1,this.invulnerabilityTimer=0}enableRegeneration(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;this.canRegenerate=!0,this.regenerationRate=t,this.regenerationDelay=e}disableRegeneration(){this.canRegenerate=!1}reset(){this.currentHealth=this.maxHealth,this.isInvulnerable=!1,this.invulnerabilityTimer=0,this.isDead=!1,this.canRegenerate=!1,this.regenerationRate=5,this.regenerationDelay=3,this.lastDamageTime=0,this.enabled=!0}clone(){let t=new n(this.maxHealth);return t.currentHealth=this.currentHealth,t.isInvulnerable=this.isInvulnerable,t.invulnerabilityDuration=this.invulnerabilityDuration,t.invulnerabilityTimer=this.invulnerabilityTimer,t.isDead=this.isDead,t.canRegenerate=this.canRegenerate,t.regenerationRate=this.regenerationRate,t.regenerationDelay=this.regenerationDelay,t.lastDamageTime=this.lastDamageTime,t}constructor(t=100){super(),this.componentType="Health",this.maxHealth=t,this.currentHealth=t,this.isInvulnerable=!1,this.invulnerabilityDuration=.5,this.invulnerabilityTimer=0,this.isDead=!1,this.canRegenerate=!1,this.regenerationRate=5,this.regenerationDelay=3,this.lastDamageTime=0}}n.componentType="Health"},6776:function(t,e,i){i.d(e,{T:function(){return n}});var s=i(1448),a=i(3980);class n extends a.w{createHealthBarMeshes(){this.group=new s.Group;let t=new s.PlaneGeometry(this.width+2*this.borderWidth,this.height+2*this.borderWidth),e=new s.MeshBasicMaterial({color:this.borderColor,transparent:!0,opacity:.8});this.borderMesh=new s.Mesh(t,e),this.borderMesh.position.z=-.001,this.group.add(this.borderMesh);let i=new s.PlaneGeometry(this.width,this.height),a=new s.MeshBasicMaterial({color:this.backgroundColor,transparent:!0,opacity:.7});this.backgroundMesh=new s.Mesh(i,a),this.group.add(this.backgroundMesh);let n=new s.PlaneGeometry(this.width,this.height),r=new s.MeshBasicMaterial({color:this.healthColor,transparent:!0,opacity:.9});this.healthMesh=new s.Mesh(n,r),this.healthMesh.position.z=.001,this.group.add(this.healthMesh),this.group.lookAt(0,0,1)}updateHealthBar(t,e,i,a){this.currentHealthRatio=Math.max(0,Math.min(1,t)),Math.abs(this.lastHealthRatio-this.currentHealthRatio)>.01?this.lastHealthRatio=s.MathUtils.lerp(this.lastHealthRatio,this.currentHealthRatio,this.animationSpeed*a):this.lastHealthRatio=this.currentHealthRatio,this.updateHealthMesh(),this.updateHealthColor(),this.updateVisibility(e,i),this.updatePositionAndRotation(e,i),this.updateDamageFlash(a)}updateHealthMesh(){this.healthMesh.scale.x=this.lastHealthRatio;let t=this.width*(1-this.lastHealthRatio)/2;this.healthMesh.position.x=-t}updateHealthColor(){let t;if(this.currentHealthRatio<=this.criticalHealthThreshold)t=this.criticalHealthColor;else if(this.currentHealthRatio<=this.lowHealthThreshold){let e=(this.currentHealthRatio-this.criticalHealthThreshold)/(this.lowHealthThreshold-this.criticalHealthThreshold);t=new s.Color().lerpColors(this.criticalHealthColor,this.lowHealthColor,e)}else{let e=(this.currentHealthRatio-this.lowHealthThreshold)/(1-this.lowHealthThreshold);t=new s.Color().lerpColors(this.lowHealthColor,this.healthColor,e)}this.healthMesh.material.color.copy(t)}updateVisibility(t,e){let i=t.distanceTo(e),s=i<=this.fadeDistance;if(!this.showWhenFull&&this.currentHealthRatio>=.99&&(s=!1),this.isVisible=s,this.group.visible=this.isVisible,this.isVisible&&i>.7*this.fadeDistance){let t=Math.max(.1,1-(i-.7*this.fadeDistance)/(.3*this.fadeDistance));this.backgroundMesh.material.opacity=.7*t,this.healthMesh.material.opacity=.9*t,this.borderMesh.material.opacity=.8*t}else this.isVisible&&(this.backgroundMesh.material.opacity=.7,this.healthMesh.material.opacity=.9,this.borderMesh.material.opacity=.8)}updatePositionAndRotation(t,e){let i=e.clone().add(this.offset);this.group.position.copy(i),this.group.lookAt(t)}updateDamageFlash(t){if(this.damageFlashTimer>0){this.damageFlashTimer-=t;let e=this.damageFlashTimer/this.damageFlashDuration,i=new s.Color(1,1,1),a=this.healthMesh.material.color.clone();a.lerp(i,.5*e),this.healthMesh.material.color.copy(a)}}triggerDamageFlash(){this.damageFlashTimer=this.damageFlashDuration}setHealthRatio(t){let e=this.currentHealthRatio;this.currentHealthRatio=Math.max(0,Math.min(1,t)),this.currentHealthRatio<e&&this.triggerDamageFlash()}getGroup(){return this.group}dispose(){this.backgroundMesh.geometry.dispose(),this.backgroundMesh.material.dispose(),this.healthMesh.geometry.dispose(),this.healthMesh.material.dispose(),this.borderMesh.geometry.dispose(),this.borderMesh.material.dispose(),this.group.parent&&this.group.parent.remove(this.group)}reset(){this.currentHealthRatio=1,this.lastHealthRatio=1,this.isVisible=!0,this.damageFlashTimer=0,this.enabled=!0,this.updateHealthMesh(),this.updateHealthColor()}clone(){return new n({width:this.width,height:this.height,offset:this.offset.clone(),backgroundColor:this.backgroundColor.clone(),healthColor:this.healthColor.clone(),lowHealthColor:this.lowHealthColor.clone(),criticalHealthColor:this.criticalHealthColor.clone(),borderColor:this.borderColor.clone(),borderWidth:this.borderWidth,showWhenFull:this.showWhenFull,fadeDistance:this.fadeDistance,lowHealthThreshold:this.lowHealthThreshold,criticalHealthThreshold:this.criticalHealthThreshold})}constructor(t={}){var e,i,a,n,r,o;super(),this.componentType="HealthBar",this.width=t.width||1,this.height=t.height||.1,this.offset=(null===(e=t.offset)||void 0===e?void 0:e.clone())||new s.Vector3(0,1.5,0),this.backgroundColor=(null===(i=t.backgroundColor)||void 0===i?void 0:i.clone())||new s.Color(3355443),this.healthColor=(null===(a=t.healthColor)||void 0===a?void 0:a.clone())||new s.Color(65280),this.lowHealthColor=(null===(n=t.lowHealthColor)||void 0===n?void 0:n.clone())||new s.Color(16776960),this.criticalHealthColor=(null===(r=t.criticalHealthColor)||void 0===r?void 0:r.clone())||new s.Color(16711680),this.borderColor=(null===(o=t.borderColor)||void 0===o?void 0:o.clone())||new s.Color(0),this.borderWidth=t.borderWidth||.02,this.showWhenFull=void 0!==t.showWhenFull&&t.showWhenFull,this.fadeDistance=t.fadeDistance||20,this.lowHealthThreshold=t.lowHealthThreshold||.5,this.criticalHealthThreshold=t.criticalHealthThreshold||.25,this.isVisible=!0,this.currentHealthRatio=1,this.lastHealthRatio=1,this.animationSpeed=5,this.damageFlashTimer=0,this.damageFlashDuration=.2,this.createHealthBarMeshes()}}n.componentType="HealthBar"},2762:function(t,e,i){i.d(e,{K:function(){return n}});var s=i(1448),a=i(3980);class n extends a.w{addServerState(t,e,i){let a=i||Date.now(),n={timestamp:a,position:t.clone(),rotation:e.clone()};if(this.buffer.length>0){let i=this.buffer[this.buffer.length-1],r=(a-i.timestamp)/1e3;if(r>0){n.velocity=t.clone().sub(i.position).divideScalar(r);let a=e.angleTo(i.rotation);n.angularVelocity=new s.Vector3(0,a/r,0)}}for(this.buffer.push(n);this.buffer.length>this.maxBufferSize;)this.buffer.shift();this.updateInterpolationState(a)}updateInterpolationState(t){if(this.buffer.length<2){1===this.buffer.length&&(this.currentState={...this.buffer[0]});return}let e=t-this.interpolationDelay,i=null,s=null;for(let t=0;t<this.buffer.length-1;t++)if(this.buffer[t].timestamp<=e&&this.buffer[t+1].timestamp>=e){i=this.buffer[t],s=this.buffer[t+1];break}if(i&&s)this.currentState=i,this.targetState=s,this.interpolationStartTime=t,this.interpolationDuration=s.timestamp-i.timestamp,this.extrapolationStartTime=0;else if(this.buffer.length>0){let e=this.buffer[this.buffer.length-1];e.velocity&&(this.lastVelocity.copy(e.velocity),this.extrapolationStartTime=t)}}getInterpolatedPosition(t){if(!this.currentState||!this.targetState){if(this.buffer.length>0){let e=this.buffer[this.buffer.length-1];if(this.extrapolationStartTime>0&&e.velocity){let i=(t-this.extrapolationStartTime)/1e3;if(i<this.maxExtrapolationTime/1e3)return e.position.clone().add(e.velocity.clone().multiplyScalar(i))}return e.position.clone()}return new s.Vector3(0,0,0)}let e=(t-this.interpolationStartTime)/this.interpolationDuration;e=Math.max(0,Math.min(1,e));let i=new s.Vector3;return i.lerpVectors(this.currentState.position,this.targetState.position,e),i}getInterpolatedRotation(t){if(!this.currentState||!this.targetState)return this.buffer.length>0?this.buffer[this.buffer.length-1].rotation.clone():new s.Quaternion;let e=(t-this.interpolationStartTime)/this.interpolationDuration;e=Math.max(0,Math.min(1,e));let i=new s.Quaternion;return i.copy(this.currentState.rotation),i.slerp(this.targetState.rotation,e),i}getInterpolatedTransform(t){return{position:this.getInterpolatedPosition(t),rotation:this.getInterpolatedRotation(t)}}isExtrapolating(t){return this.extrapolationStartTime>0&&t-this.extrapolationStartTime<this.maxExtrapolationTime}getBufferStats(){return{bufferSize:this.buffer.length,maxBufferSize:this.maxBufferSize,interpolationDelay:this.interpolationDelay,isInterpolating:null!==this.currentState&&null!==this.targetState,isExtrapolating:this.extrapolationStartTime>0,latestTimestamp:this.buffer.length>0?this.buffer[this.buffer.length-1].timestamp:null}}clearBuffer(){this.buffer.length=0,this.currentState=null,this.targetState=null,this.interpolationStartTime=0,this.extrapolationStartTime=0}reset(){this.clearBuffer(),this.lastVelocity.set(0,0,0),this.lastAngularVelocity.set(0,0,0),this.enabled=!0}constructor(){super(),this.componentType="InterpolationBuffer",this.buffer=[],this.maxBufferSize=10,this.interpolationDelay=100,this.currentState=null,this.targetState=null,this.interpolationStartTime=0,this.interpolationDuration=0,this.lastVelocity=new s.Vector3,this.lastAngularVelocity=new s.Vector3,this.extrapolationStartTime=0,this.maxExtrapolationTime=500}}n.componentType="InterpolationBuffer"},7771:function(t,e,i){i.d(e,{i:function(){return n}});var s=i(1448),a=i(3980);class n extends a.w{addForce(t){this.acceleration.add(t)}addImpulse(t){this.velocity.add(t)}jump(){this.canJump&&(this.isGrounded||this.canFly)&&(this.velocity.y=this.jumpForce,this.isGrounded=!1)}setMoveDirection(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this.moveDirection.copy(t).normalize(),this.inputStrength=Math.max(0,Math.min(1,e))}freeze(t){let e=Date.now();this.isFrozen=!0,this.frozenUntil=e+t}slow(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,i=Date.now();this.isSlowed=!0,this.slowedUntil=i+t,this.movementSpeedMultiplier=e}updateDebuffs(){let t=Date.now();this.isFrozen&&t>=this.frozenUntil&&(this.isFrozen=!1,this.frozenUntil=0),this.isSlowed&&t>=this.slowedUntil&&(this.isSlowed=!1,this.slowedUntil=0,this.movementSpeedMultiplier=1)}getEffectiveMaxSpeed(){return this.isFrozen?0:this.maxSpeed*this.movementSpeedMultiplier}startDash(t,e,i){if(this.isDashing)return!1;let s=this.dashCharges.findIndex(t=>t.isAvailable);return -1!==s&&(this.isDashing=!0,this.dashDirection.copy(t).normalize(),this.dashStartTime=i,this.dashStartPosition.copy(e),this.dashCharges[s].isAvailable=!1,this.dashCharges[s].cooldownStartTime=i,setTimeout(()=>{this.dashCharges[s].isAvailable=!0,this.dashCharges[s].cooldownStartTime=null},6e3),!0)}updateDash(t){if(!this.isDashing)return{isComplete:!1,newPosition:null};let e=Math.min((t-this.dashStartTime)/this.dashDuration,1);if(e>=1)return this.isDashing=!1,{isComplete:!0,newPosition:this.dashStartPosition.clone().add(this.dashDirection.clone().multiplyScalar(this.dashDistance))};let i=this.dashDirection.clone().multiplyScalar(this.dashDistance*(1-Math.pow(1-e,2)));return{isComplete:!1,newPosition:this.dashStartPosition.clone().add(i)}}cancelDash(){this.isDashing=!1,this.dashDirection.set(0,0,0),this.dashStartTime=0}stop(){this.velocity.set(0,0,0),this.acceleration.set(0,0,0),this.moveDirection.set(0,0,0),this.inputStrength=0}getSpeed(){return this.velocity.length()}getHorizontalSpeed(){return Math.sqrt(this.velocity.x*this.velocity.x+this.velocity.z*this.velocity.z)}isMoving(){return this.getSpeed()>.01}isMovingHorizontally(){return this.getHorizontalSpeed()>.01}isFalling(){return this.velocity.y<-.1}isRising(){return this.velocity.y>.1}getAvailableDashCharges(){return this.dashCharges.filter(t=>t.isAvailable).length}getDashChargeStatus(){let t=Date.now()/1e3;return this.dashCharges.map(e=>({isAvailable:e.isAvailable,cooldownRemaining:e.cooldownStartTime?Math.max(0,6-(t-e.cooldownStartTime)):0}))}startCharge(t,e,i){return!this.isCharging&&!this.isDashing&&(this.isCharging=!0,this.chargeDirection.copy(t).normalize(),this.chargeStartTime=i,this.chargeStartPosition.copy(e),!0)}updateCharge(t){if(!this.isCharging)return{isComplete:!1,newPosition:null};let e=Math.min((t-this.chargeStartTime)/this.chargeDuration,1);if(e>=1)return this.isCharging=!1,{isComplete:!0,newPosition:this.chargeStartPosition.clone().add(this.chargeDirection.clone().multiplyScalar(this.chargeDistance))};let i=this.chargeDirection.clone().multiplyScalar(this.chargeDistance*(1-Math.pow(1-e,2)));return{isComplete:!1,newPosition:this.chargeStartPosition.clone().add(i)}}cancelCharge(){this.isCharging=!1,this.chargeDirection.set(0,0,0),this.chargeStartTime=0}clampVelocity(){let t=this.getEffectiveMaxSpeed(),e=new s.Vector3(this.velocity.x,0,this.velocity.z);e.length()>t&&(0===t?(this.velocity.x=0,this.velocity.z=0):(e.normalize().multiplyScalar(t),this.velocity.x=e.x,this.velocity.z=e.z))}applyFriction(t){if(!this.canMove)return;let e=Math.pow(this.friction,t);this.velocity.x*=e,this.velocity.z*=e,.01>Math.abs(this.velocity.x)&&(this.velocity.x=0),.01>Math.abs(this.velocity.z)&&(this.velocity.z=0)}applyGravity(t){this.canFly||(this.velocity.y+=this.gravity*t)}reset(){this.velocity?this.velocity.set(0,0,0):this.velocity=new s.Vector3(0,0,0),this.acceleration?this.acceleration.set(0,0,0):this.acceleration=new s.Vector3(0,0,0),this.moveDirection?this.moveDirection.set(0,0,0):this.moveDirection=new s.Vector3(0,0,0),this.inputStrength=0,this.isGrounded=!1,this.canMove=!0,this.canJump=!0,this.canFly=!1,this.maxSpeed=5,this.friction=.8,this.jumpForce=20,this.gravity=-12.5,this.enabled=!0,this.isFrozen=!1,this.frozenUntil=0,this.isSlowed=!1,this.slowedUntil=0,this.movementSpeedMultiplier=1,this.isDashing=!1,this.dashDirection.set(0,0,0),this.dashStartTime=0,this.dashDuration=.35,this.dashDistance=4,this.dashStartPosition.set(0,0,0),this.maxDashCharges=3,this.dashCharges=Array.from({length:this.maxDashCharges},()=>({isAvailable:!0,cooldownStartTime:null})),this.isCharging=!1,this.chargeDirection.set(0,0,0),this.chargeStartTime=0,this.chargeDuration=.35,this.chargeDistance=9,this.chargeStartPosition.set(0,0,0)}clone(){let t=new n(this.maxSpeed,this.friction,this.jumpForce,this.gravity);return t.velocity.copy(this.velocity),t.acceleration.copy(this.acceleration),t.moveDirection.copy(this.moveDirection),t.inputStrength=this.inputStrength,t.isGrounded=this.isGrounded,t.canMove=this.canMove,t.canJump=this.canJump,t.canFly=this.canFly,t.isFrozen=this.isFrozen,t.frozenUntil=this.frozenUntil,t.isSlowed=this.isSlowed,t.slowedUntil=this.slowedUntil,t.movementSpeedMultiplier=this.movementSpeedMultiplier,t.isDashing=this.isDashing,t.dashDirection.copy(this.dashDirection),t.dashStartTime=this.dashStartTime,t.dashDuration=this.dashDuration,t.dashDistance=this.dashDistance,t.dashStartPosition.copy(this.dashStartPosition),t.maxDashCharges=this.maxDashCharges,t.dashCharges=this.dashCharges.map(t=>({isAvailable:t.isAvailable,cooldownStartTime:t.cooldownStartTime})),t.isCharging=this.isCharging,t.chargeDirection.copy(this.chargeDirection),t.chargeStartTime=this.chargeStartTime,t.chargeDuration=this.chargeDuration,t.chargeDistance=this.chargeDistance,t.chargeStartPosition.copy(this.chargeStartPosition),t}constructor(t=3.75,e=.8,i=20,a=-12.5){super(),this.componentType="Movement",this.velocity=new s.Vector3(0,0,0),this.acceleration=new s.Vector3(0,0,0),this.maxSpeed=t,this.friction=e,this.isGrounded=!1,this.jumpForce=i,this.gravity=a,this.canMove=!0,this.canJump=!0,this.canFly=!1,this.isFrozen=!1,this.frozenUntil=0,this.isSlowed=!1,this.slowedUntil=0,this.movementSpeedMultiplier=1,this.moveDirection=new s.Vector3(0,0,0),this.inputStrength=0,this.isDashing=!1,this.dashDirection=new s.Vector3(0,0,0),this.dashStartTime=0,this.dashDuration=.35,this.dashDistance=4,this.dashStartPosition=new s.Vector3(0,0,0),this.maxDashCharges=3,this.dashCharges=Array.from({length:this.maxDashCharges},()=>({isAvailable:!0,cooldownStartTime:null})),this.isCharging=!1,this.chargeDirection=new s.Vector3(0,0,0),this.chargeStartTime=0,this.chargeDuration=.35,this.chargeDistance=9,this.chargeStartPosition=new s.Vector3(0,0,0)}}n.componentType="Movement"},1168:function(t,e,i){i.d(e,{W:function(){return n}});var s=i(1448),a=i(3980);class n extends a.w{setDirection(t){this.velocity.copy(t).normalize().multiplyScalar(this.speed)}addGravity(t){this.gravity=t}setPiercing(t){this.piercing=t}setExplosive(t){this.explosionRadius=t}setBouncing(t){this.maxBounces=t}setMaxDistance(t){this.maxDistance=t}setStartPosition(t){this.startPosition.copy(t)}setHoming(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.8,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Math.PI;this.targetEntityId=t,this.homingStrength=Math.max(0,Math.min(1,e)),this.maxTurnRate=i}disableHoming(){this.targetEntityId=null,this.homingStrength=0}hasHitTarget(t){return this.hitTargets.has(t)}addHitTarget(t){this.hitTargets.add(t)}canHitTarget(t){return t!==this.owner&&(!!this.piercing||!this.hasHitTarget(t))}isExpired(){return this.lifetime>=this.maxLifetime||this.distanceTraveled>=this.maxDistance}canBounce(){return this.bounces<this.maxBounces}bounce(t){if(!this.canBounce())return;let e=this.velocity.clone().reflect(t);this.velocity.copy(e),this.bounces++}update(t){this.lifetime+=t;let e=this.velocity.length()*t;this.distanceTraveled+=e,0!==this.gravity&&(this.velocity.y+=this.gravity*t)}getPosition(t){return t.clone()}getPredictedPosition(t,e){let i=t.clone();return i.add(this.velocity.clone().multiplyScalar(e)),i}reset(){this.velocity.set(0,0,0),this.speed=20,this.damage=10,this.lifetime=0,this.maxLifetime=5,this.piercing=!1,this.hitTargets.clear(),this.explosionRadius=0,this.gravity=0,this.bounces=0,this.maxBounces=0,this.owner=-1,this.distanceTraveled=0,this.maxDistance=1/0,this.startPosition.set(0,0,0),this.targetEntityId=null,this.homingStrength=0,this.maxTurnRate=Math.PI,this.enabled=!0}clone(){let t=new n(this.speed,this.damage,this.maxLifetime,this.owner);return t.velocity.copy(this.velocity),t.lifetime=this.lifetime,t.piercing=this.piercing,t.hitTargets=new Set(this.hitTargets),t.explosionRadius=this.explosionRadius,t.gravity=this.gravity,t.bounces=this.bounces,t.maxBounces=this.maxBounces,t.distanceTraveled=this.distanceTraveled,t.maxDistance=this.maxDistance,t.startPosition.copy(this.startPosition),t.targetEntityId=this.targetEntityId,t.homingStrength=this.homingStrength,t.maxTurnRate=this.maxTurnRate,t}constructor(t=20,e=10,i=5,a=-1){super(),this.componentType="Projectile",this.velocity=new s.Vector3(0,0,0),this.speed=t,this.damage=e,this.lifetime=0,this.maxLifetime=i,this.piercing=!1,this.hitTargets=new Set,this.explosionRadius=0,this.gravity=0,this.bounces=0,this.maxBounces=0,this.owner=a,this.distanceTraveled=0,this.maxDistance=1/0,this.startPosition=new s.Vector3(0,0,0),this.targetEntityId=null,this.homingStrength=0,this.maxTurnRate=Math.PI}}n.componentType="Projectile"},246:function(t,e,i){i.d(e,{T:function(){return n}});var s=i(1448),a=i(3980);class n extends a.w{setGeometry(t){this.geometry&&this.geometry!==t&&this.geometry.dispose(),this.geometry=t,this.needsUpdate=!0}setMaterial(t){this.material&&this.material!==t&&(Array.isArray(this.material)?this.material.forEach(t=>t.dispose()):this.material.dispose()),this.material=t,this.needsUpdate=!0}createMesh(){return this.geometry&&this.material?(this.mesh&&this.disposeMesh(),this.mesh=new s.Mesh(this.geometry,this.material),this.mesh.castShadow=this.castShadow,this.mesh.receiveShadow=this.receiveShadow,this.mesh.frustumCulled=this.frustumCulled,this.mesh.visible=this.visible,this.mesh.renderOrder=this.renderOrder,this.needsUpdate=!1,this.mesh):null}updateMesh(){this.mesh&&(this.mesh instanceof s.Mesh?(this.mesh.castShadow=this.castShadow,this.mesh.receiveShadow=this.receiveShadow):this.mesh instanceof s.Group&&this.mesh.traverse(t=>{t instanceof s.Mesh&&(t.castShadow=this.castShadow,t.receiveShadow=this.receiveShadow)}),this.mesh.frustumCulled=this.frustumCulled,this.mesh.visible=this.visible,this.mesh.renderOrder=this.renderOrder,this.needsUpdate&&this.geometry&&this.material&&this.mesh instanceof s.Mesh&&(this.mesh.geometry=this.geometry,this.mesh.material=this.material,this.needsUpdate=!1))}setVisible(t){this.visible=t,this.mesh&&(this.mesh.visible=t)}setCastShadow(t){this.castShadow=t,this.mesh instanceof s.Mesh?this.mesh.castShadow=t:this.mesh instanceof s.Group&&this.mesh.traverse(e=>{e instanceof s.Mesh&&(e.castShadow=t)})}setReceiveShadow(t){this.receiveShadow=t,this.mesh instanceof s.Mesh?this.mesh.receiveShadow=t:this.mesh instanceof s.Group&&this.mesh.traverse(e=>{e instanceof s.Mesh&&(e.receiveShadow=t)})}setupAnimations(t){this.mesh&&(this.animations=t,t.length>0&&(this.animationMixer=new s.AnimationMixer(this.mesh)))}playAnimation(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.2;if(!this.animationMixer)return null;let a=this.animations.find(e=>e.name===t);if(!a)return null;this.currentAnimation&&this.currentAnimation.fadeOut(i);let n=this.animationMixer.clipAction(a);return n.setLoop(e?s.LoopRepeat:s.LoopOnce,e?1/0:1),n.fadeIn(i),n.play(),this.currentAnimation=n,n}stopAnimation(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.2;this.currentAnimation&&(this.currentAnimation.fadeOut(t),this.currentAnimation=null)}updateAnimations(t){this.animationMixer&&this.animationMixer.update(t)}setupInstancing(t,e){this.isInstanced=!0,this.instancedMesh=t,this.instanceId=e}updateInstanceMatrix(t){this.isInstanced&&this.instancedMesh&&this.instanceId>=0&&(this.instancedMesh.setMatrixAt(this.instanceId,t),this.instancedMesh.instanceMatrix.needsUpdate=!0)}setInstanceVisible(t){if(this.isInstanced&&this.instancedMesh&&this.instanceId>=0){let e=new s.Matrix4;this.instancedMesh.getMatrixAt(this.instanceId,e),t||e.scale(new s.Vector3(0,0,0)),this.instancedMesh.setMatrixAt(this.instanceId,e),this.instancedMesh.instanceMatrix.needsUpdate=!0}}disposeMesh(){this.mesh&&(this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.mesh=null)}dispose(){this.disposeMesh(),this.geometry&&(this.geometry.dispose(),this.geometry=null),this.material&&(Array.isArray(this.material)?this.material.forEach(t=>t.dispose()):this.material.dispose(),this.material=null),this.animationMixer&&(this.animationMixer.stopAllAction(),this.animationMixer=null),this.animations=[],this.currentAnimation=null,this.instancedMesh=null}reset(){this.dispose(),this.castShadow=!0,this.receiveShadow=!0,this.frustumCulled=!0,this.visible=!0,this.renderOrder=0,this.needsUpdate=!0,this.isInstanced=!1,this.instanceId=-1,this.enabled=!0}clone(){return new n({castShadow:this.castShadow,receiveShadow:this.receiveShadow,frustumCulled:this.frustumCulled,visible:this.visible,renderOrder:this.renderOrder})}constructor(t={}){var e,i,s,a,n;super(),this.componentType="Renderer",this.mesh=null,this.geometry=null,this.material=null,this.animationMixer=null,this.animations=[],this.currentAnimation=null,this.isInstanced=!1,this.instancedMesh=null,this.instanceId=-1,this.castShadow=null===(e=t.castShadow)||void 0===e||e,this.receiveShadow=null===(i=t.receiveShadow)||void 0===i||i,this.frustumCulled=null===(s=t.frustumCulled)||void 0===s||s,this.visible=null===(a=t.visible)||void 0===a||a,this.renderOrder=null!==(n=t.renderOrder)&&void 0!==n?n:0,this.needsUpdate=!0}}n.componentType="Renderer"},3974:function(t,e,i){i.d(e,{W:function(){return a}});var s=i(3980);class a extends s.w{absorbDamage(t){if(this.currentShield<=0)return t;let e=Math.min(t,this.currentShield);return this.currentShield-=e,this.lastDamageTime=Date.now(),this.isRegenerating=!1,t-e}update(t){if(this.currentShield>=this.maxShield){this.isRegenerating=!1;return}if((Date.now()-this.lastDamageTime)/1e3>=this.regenDelay){this.isRegenerating||(this.isRegenerating=!0);let e=this.regenRate*t;this.currentShield=Math.min(this.maxShield,this.currentShield+e)}}getShieldPercentage(){return this.maxShield>0?this.currentShield/this.maxShield:0}isFullShield(){return this.currentShield>=this.maxShield}isShieldDepleted(){return this.currentShield<=0}restoreShield(){this.currentShield=this.maxShield,this.isRegenerating=!1}setShield(t,e){this.currentShield=Math.max(0,Math.min(e,t)),this.maxShield=e}reset(){this.currentShield=this.maxShield,this.lastDamageTime=0,this.isRegenerating=!1,this.enabled=!0}constructor(t=200,e=20,i=5){super(),this.componentType="Shield",this.maxShield=t,this.currentShield=t,this.regenRate=e,this.regenDelay=i,this.lastDamageTime=0,this.isRegenerating=!1}}a.componentType="Shield"},2487:function(t,e,i){i.d(e,{a:function(){return a}});var s=i(3980);class a extends s.w{canAttack(t){return!!this.isActive&&!this.isDead&&!!this.currentTarget&&t-this.lastAttackTime>=this.attackCooldown}performAttack(t){this.lastAttackTime=t}canSearchForTargets(t){return t-this.lastTargetSearchTime>=this.targetSearchCooldown}updateTargetSearch(t){this.lastTargetSearchTime=t}setTarget(t){this.currentTarget=t}clearTarget(){this.currentTarget=null}die(t){this.isDead=!0,this.isActive=!1,this.deathTime=t,this.clearTarget()}isExpired(t){return this.isDead||t-this.summonTime>=this.lifetime}getDisplayName(){return"Unit (".concat(this.ownerId,")")}reset(){this.ownerId="",this.unitId="",this.attackRange=4,this.attackDamage=15,this.attackCooldown=1,this.lastAttackTime=0,this.maxHealth=500,this.moveSpeed=2.5,this.targetPosition=null,this.currentTarget=null,this.lastTargetSearchTime=0,this.targetSearchCooldown=.5,this.isActive=!0,this.isDead=!1,this.deathTime=0,this.summonTime=Date.now()/1e3,this.lifetime=120,this.enabled=!0}clone(){let t=new a(this.ownerId,this.unitId,this.targetPosition);return t.attackRange=this.attackRange,t.attackDamage=this.attackDamage,t.attackCooldown=this.attackCooldown,t.lastAttackTime=this.lastAttackTime,t.maxHealth=this.maxHealth,t.moveSpeed=this.moveSpeed,t.currentTarget=this.currentTarget,t.lastTargetSearchTime=this.lastTargetSearchTime,t.targetSearchCooldown=this.targetSearchCooldown,t.isActive=this.isActive,t.isDead=this.isDead,t.deathTime=this.deathTime,t.summonTime=this.summonTime,t.lifetime=this.lifetime,t}constructor(t="",e="",i=null){super(),this.componentType="SummonedUnit",this.ownerId=t,this.unitId=e,this.attackRange=4,this.attackDamage=15,this.attackCooldown=1,this.lastAttackTime=0,this.maxHealth=500,this.moveSpeed=2.5,this.targetPosition=i,this.currentTarget=null,this.lastTargetSearchTime=0,this.targetSearchCooldown=.5,this.isActive=!0,this.isDead=!1,this.deathTime=0,this.summonTime=Date.now()/1e3,this.lifetime=120}}a.componentType="SummonedUnit"},2115:function(t,e,i){i.d(e,{N:function(){return a}});var s=i(3980);class a extends s.w{canAttack(t){return!!this.isActive&&!this.isDead&&!!this.currentTarget&&t-this.lastAttackTime>=this.attackCooldown}performAttack(t){this.lastAttackTime=t}canSearchForTargets(t){return t-this.lastTargetSearchTime>=this.targetSearchCooldown}updateTargetSearch(t){this.lastTargetSearchTime=t}setTarget(t){this.currentTarget=t}clearTarget(){this.currentTarget=null}die(t){this.isDead=!0,this.isActive=!1,this.deathTime=t,this.clearTarget()}getDisplayName(){return"Tower ".concat(this.towerIndex+1," (Owner: ").concat(this.ownerId,")")}reset(){this.ownerId="",this.towerIndex=0,this.attackRange=10,this.attackDamage=25,this.attackCooldown=1.5,this.lastAttackTime=0,this.projectileSpeed=20,this.currentTarget=null,this.targetSearchRange=9,this.lastTargetSearchTime=0,this.targetSearchCooldown=.5,this.isActive=!0,this.isDead=!1,this.deathTime=0,this.enabled=!0}clone(){let t=new a(this.ownerId,this.towerIndex);return t.attackRange=this.attackRange,t.attackDamage=this.attackDamage,t.attackCooldown=this.attackCooldown,t.lastAttackTime=this.lastAttackTime,t.projectileSpeed=this.projectileSpeed,t.currentTarget=this.currentTarget,t.targetSearchRange=this.targetSearchRange,t.lastTargetSearchTime=this.lastTargetSearchTime,t.targetSearchCooldown=this.targetSearchCooldown,t.isActive=this.isActive,t.isDead=this.isDead,t.deathTime=this.deathTime,t}constructor(t="",e=0){super(),this.componentType="Tower",this.ownerId=t,this.towerIndex=e,this.attackRange=13.5,this.attackDamage=100,this.attackCooldown=1.5,this.lastAttackTime=0,this.projectileSpeed=20,this.currentTarget=null,this.targetSearchRange=this.attackRange+1,this.lastTargetSearchTime=0,this.targetSearchCooldown=.5,this.isActive=!0,this.isDead=!1,this.deathTime=0}}a.componentType="Tower"},73:function(t,e,i){i.d(e,{w:function(){return n}});var s=i(1448),a=i(3980);class n extends a.w{setPosition(t,e,i){this.position.set(t,e,i),this.markMatrixDirty()}setRotation(t,e,i){this.rotation.set(t,e,i),this.updateQuaternion(),this.markMatrixDirty()}setScale(t,e,i){this.scale.set(t,e,i),this.markMatrixDirty()}translate(t,e,i){this.position.x+=t,this.position.y+=e,this.position.z+=i,this.markMatrixDirty()}rotate(t,e,i){this.rotation.x+=t,this.rotation.y+=e,this.rotation.z+=i,this.updateQuaternion(),this.markMatrixDirty()}lookAt(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new s.Vector3(0,1,0),i=new s.Matrix4;i.lookAt(this.position,t,e),this.quaternion.setFromRotationMatrix(i),this.rotation.setFromQuaternion(this.quaternion),this.markMatrixDirty()}getForward(){let t=new s.Vector3(0,0,-1);return t.applyQuaternion(this.quaternion),t}getRight(){let t=new s.Vector3(1,0,0);return t.applyQuaternion(this.quaternion),t}getUp(){let t=new s.Vector3(0,1,0);return t.applyQuaternion(this.quaternion),t}getWorldPosition(){this.updateWorldMatrix();let t=new s.Vector3;return t.setFromMatrixPosition(this.worldMatrix),t}getWorldRotation(){this.updateWorldMatrix();let t=new s.Quaternion;return t.setFromRotationMatrix(this.worldMatrix),t}getWorldScale(){this.updateWorldMatrix();let t=new s.Vector3;return t.setFromMatrixScale(this.worldMatrix),t}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixNeedsUpdate=!1}updateWorldMatrix(){this.matrixNeedsUpdate&&this.updateMatrix(),this.parent?(this.parent.updateWorldMatrix(),this.worldMatrix.multiplyMatrices(this.parent.worldMatrix,this.matrix)):this.worldMatrix.copy(this.matrix)}addChild(t){t.parent&&t.parent.removeChild(t),t.parent=this,this.children.push(t)}removeChild(t){let e=this.children.indexOf(t);-1!==e&&(this.children.splice(e,1),t.parent=null)}removeFromParent(){this.parent&&this.parent.removeChild(this)}updateQuaternion(){this.quaternion.setFromEuler(this.rotation)}markMatrixDirty(){for(let t of(this.matrixNeedsUpdate=!0,this.children))t.markMatrixDirty()}reset(){for(this.position?this.position.set(0,0,0):this.position=new s.Vector3(0,0,0),this.rotation?this.rotation.set(0,0,0):this.rotation=new s.Euler(0,0,0),this.scale?this.scale.set(1,1,1):this.scale=new s.Vector3(1,1,1),this.quaternion?this.quaternion.set(0,0,0,1):this.quaternion=new s.Quaternion,this.matrix?this.matrix.identity():this.matrix=new s.Matrix4,this.worldMatrix?this.worldMatrix.identity():this.worldMatrix=new s.Matrix4,this.matrixNeedsUpdate=!0,this.removeFromParent();this.children.length>0;)this.removeChild(this.children[0]);this.enabled=!0}clone(){let t=new n(this.position,this.rotation,this.scale);return t.quaternion.copy(this.quaternion),t}constructor(t=new s.Vector3(0,0,0),e=new s.Euler(0,0,0),i=new s.Vector3(1,1,1)){super(),this.componentType="Transform",this.matrixNeedsUpdate=!0,this.parent=null,this.children=[],this.position=t.clone(),this.rotation=e.clone(),this.scale=i.clone(),this.quaternion=new s.Quaternion,this.matrix=new s.Matrix4,this.worldMatrix=new s.Matrix4,this.updateQuaternion()}}n.componentType="Transform"},2082:function(t,e,i){i.d(e,{D:function(){return o}});var s=i(1448),a=i(9131),n=i(73),r=i(6366);class o extends a.xP{setTarget(t){this.target=t}setConfig(t){this.config={...this.config,...t},this.spherical.radius=this.config.distance}update(t,e){if(!this.target)return;let i=this.target.getComponent(n.w);i&&(this.handleMouseInput(),this.targetLookAt.copy(i.position),this.targetLookAt.y+=this.config.height,this.targetPosition.setFromSpherical(this.spherical),this.targetPosition.add(this.targetLookAt),this.currentPosition.lerp(this.targetPosition,this.config.smoothing),this.currentLookAt.lerp(this.targetLookAt,this.config.smoothing),this.camera.position.copy(this.currentPosition),this.camera.lookAt(this.currentLookAt))}handleMouseInput(){let t=this.inputManager.getMouseDelta();(0!==t.x||0!==t.y)&&this.isRightMouseDown&&(this.spherical.theta-=t.x*this.config.mouseSensitivity,this.spherical.phi-=t.y*this.config.mouseSensitivity,this.spherical.phi=r.M.clamp(this.spherical.phi,this.config.minPolarAngle,this.config.maxPolarAngle),this.spherical.theta=r.M.normalizeAngle(this.spherical.theta))}setupEventListeners(){this.inputManager.on("mouseDown",t=>{let{button:e}=t;2===e&&(this.isRightMouseDown=!0)}),this.inputManager.on("mouseUp",t=>{let{button:e}=t;2===e&&(this.isRightMouseDown=!1)}),this.wheelListenerAdded||(this.inputManager.on("wheel",t=>{let{deltaY:e}=t;this.spherical.radius+=.01*e,this.spherical.radius=r.M.clamp(this.spherical.radius,2,this.config.maxDistance)}),this.wheelListenerAdded=!0)}setupInitialPosition(){this.currentPosition.setFromSpherical(this.spherical),this.currentLookAt.set(0,this.config.height,0),this.targetPosition.copy(this.currentPosition),this.targetLookAt.copy(this.currentLookAt),this.camera.position.copy(this.currentPosition),this.camera.lookAt(this.currentLookAt)}getCameraDirection(){let t=new s.Vector3;return this.camera.getWorldDirection(t),t}getCameraRight(){let t=this.getCameraDirection(),e=new s.Vector3;return e.crossVectors(t,new s.Vector3(0,1,0)),e.normalize(),e}getCameraForward(){let t=this.getCameraRight(),e=new s.Vector3;return e.crossVectors(new s.Vector3(0,1,0),t),e.normalize(),e}getDistance(){return this.spherical.radius}setDistance(t){this.spherical.radius=r.M.clamp(t,2,this.config.maxDistance)}getHorizontalAngle(){return this.spherical.theta}getVerticalAngle(){return this.spherical.phi}setAngles(t,e){this.spherical.theta=r.M.normalizeAngle(t),this.spherical.phi=r.M.clamp(e,this.config.minPolarAngle,this.config.maxPolarAngle)}resetCamera(){this.spherical.radius=this.config.distance,this.spherical.phi=Math.PI/3,this.spherical.theta=0,this.setupInitialPosition()}snapToTarget(){if(!this.target)return;let t=this.target.getComponent(n.w);if(t&&t.position){if(void 0===t.position.x||void 0===t.position.y||void 0===t.position.z)return;this.targetLookAt.copy(t.position),this.targetLookAt.y+=this.config.height,this.targetPosition.setFromSpherical(this.spherical),this.targetPosition.add(this.targetLookAt),this.currentPosition.copy(this.targetPosition),this.currentLookAt.copy(this.targetLookAt),this.camera.position.copy(this.currentPosition),this.camera.lookAt(this.currentLookAt)}}getCamera(){return this.camera}constructor(t,e,i){super(),this.requiredComponents=[n.w],this.target=null,this.config={distance:10,height:5,mouseSensitivity:.005,smoothing:.1,minPolarAngle:Math.PI/3.5,maxPolarAngle:Math.PI/2.5,maxDistance:11.5},this.spherical=new s.Spherical(10,Math.PI/3,0),this.targetPosition=new s.Vector3,this.currentPosition=new s.Vector3,this.currentLookAt=new s.Vector3,this.targetLookAt=new s.Vector3,this.isRightMouseDown=!1,this.wheelListenerAdded=!1,this.camera=t,this.inputManager=e,this.priority=900,i&&(this.config={...this.config,...i}),this.spherical.radius=this.config.distance,this.spherical.phi=Math.PI/3,this.spherical.theta=0,this.setupEventListeners(),this.setupInitialPosition()}}},2158:function(t,e,i){i.d(e,{s:function(){return l}});var s=i(1448),a=i(9131),n=i(73),r=i(7771),o=i(3478),h=i(4183);class l extends a.FU{update(t,e){this.updateSpatialHash(t),this.detectCollisions(t),this.processCollisionCallbacks(),this.resolveCollisions()}fixedUpdate(t,e){this.resolveCollisions()}updateSpatialHash(t){for(let e of t){let t=e.getComponent(n.w),i=e.getComponent(o.YM);if(!t.enabled||!i.enabled){this.spatialHash.remove(e);continue}i.updateBounds(t.getWorldPosition()),this.spatialHash.update(e,i.bounds)}}detectCollisions(t){this.collisionPairs.length=0,this.collisionChecks=0,this.actualCollisions=0;let e=new Set;for(let i of t){let t=i.getComponent(n.w),s=i.getComponent(o.YM);if(t.enabled&&s.enabled)for(let a of this.spatialHash.query(s.bounds)){let r=a.entity;if(i.id===r.id)continue;let h=i.id<r.id?"".concat(i.id,"-").concat(r.id):"".concat(r.id,"-").concat(i.id);if(e.has(h))continue;e.add(h);let l=r.getComponent(n.w),c=r.getComponent(o.YM);if((null==l?void 0:l.enabled)&&(null==c?void 0:c.enabled)&&s.canCollideWith(c)&&(this.collisionChecks++,s.intersects(c,t.getWorldPosition(),l.getWorldPosition()))){this.actualCollisions++,2===s.layer&&16===c.layer||16===s.layer&&c.layer;let t={entityA:i,entityB:r,colliderA:s,colliderB:c};this.collisionPairs.push(t)}}}}processCollisionCallbacks(){let t=new Map;for(let e of this.collisionPairs){let i=e.entityA.id<e.entityB.id?"".concat(e.entityA.id,"-").concat(e.entityB.id):"".concat(e.entityB.id,"-").concat(e.entityA.id);t.set(i,e),this.activeCollisions.has(i)?this.triggerCollisionStay(e):this.triggerCollisionEnter(e)}this.activeCollisions.forEach((e,i)=>{t.has(i)||this.triggerCollisionExit(e)}),this.activeCollisions=t}triggerCollisionEnter(t){var e,i,s,a,n,r,o,h;t.colliderA.isTrigger||t.colliderB.isTrigger?(null===(e=(i=t.colliderA).onTriggerEnter)||void 0===e||e.call(i,t.colliderB,t.entityB),null===(s=(a=t.colliderB).onTriggerEnter)||void 0===s||s.call(a,t.colliderA,t.entityA)):(null===(n=(r=t.colliderA).onCollisionEnter)||void 0===n||n.call(r,t.colliderB,t.entityB),null===(o=(h=t.colliderB).onCollisionEnter)||void 0===o||o.call(h,t.colliderA,t.entityA))}triggerCollisionStay(t){var e,i,s,a,n,r,o,h;t.colliderA.isTrigger||t.colliderB.isTrigger?(null===(e=(i=t.colliderA).onTriggerStay)||void 0===e||e.call(i,t.colliderB,t.entityB),null===(s=(a=t.colliderB).onTriggerStay)||void 0===s||s.call(a,t.colliderA,t.entityA)):(null===(n=(r=t.colliderA).onCollisionStay)||void 0===n||n.call(r,t.colliderB,t.entityB),null===(o=(h=t.colliderB).onCollisionStay)||void 0===o||o.call(h,t.colliderA,t.entityA))}triggerCollisionExit(t){var e,i,s,a,n,r,o,h;t.colliderA.isTrigger||t.colliderB.isTrigger?(null===(e=(i=t.colliderA).onTriggerExit)||void 0===e||e.call(i,t.colliderB,t.entityB),null===(s=(a=t.colliderB).onTriggerExit)||void 0===s||s.call(a,t.colliderA,t.entityA)):(null===(n=(r=t.colliderA).onCollisionExit)||void 0===n||n.call(r,t.colliderB,t.entityB),null===(o=(h=t.colliderB).onCollisionExit)||void 0===o||o.call(h,t.colliderA,t.entityA))}resolveCollisions(){for(let t of this.collisionPairs)t.colliderA.isTrigger||t.colliderB.isTrigger||this.resolveCollision(t)}resolveCollision(t){let e=t.entityA.getComponent(n.w),i=t.entityB.getComponent(n.w),s=e.getWorldPosition(),a=i.getWorldPosition();if(!s||!s.clone||!a||!a.clone)return;let h=s.clone().sub(a),l=h.length();0===l?h.set(0,1,0):h.normalize();let c=0,d=("sphere"===t.colliderA.type&&"sphere"===t.colliderB.type?t.colliderA.radius+t.colliderB.radius:"sphere"===t.colliderA.type&&"cylinder"===t.colliderB.type?t.colliderA.radius+t.colliderB.radius:"cylinder"===t.colliderA.type&&"sphere"===t.colliderB.type?t.colliderA.radius+t.colliderB.radius:this.getApproximateRadius(t.colliderA)+this.getApproximateRadius(t.colliderB))-l;if(d>0){2===t.colliderA.layer&&16===t.colliderB.layer||16===t.colliderA.layer&&t.colliderB.layer;let s=1;(t.colliderA.isStatic||t.colliderB.isStatic)&&(s=1.1);let a=h.multiplyScalar(d*s),n=t.entityA.getComponent(r.i),l=t.entityB.getComponent(r.i),c=.5,u=.5;if(t.colliderA.isStatic&&!t.colliderB.isStatic)c=0,u=1;else if(!t.colliderA.isStatic&&t.colliderB.isStatic)c=1,u=0;else if(!t.colliderA.isStatic&&!t.colliderB.isStatic){let e=t.colliderA.layer===o.aB.PLAYER,i=t.colliderB.layer===o.aB.PLAYER||t.colliderB.layer===o.aB.ENEMY;if(e&&i){let t=!!n&&n.canMove,e=!!l&&l.canMove;t&&e?(c=.5,u=.5):t&&!e?(c=1,u=0):!t&&e?(c=0,u=1):(c=0,u=0)}else n&&!l?(c=.8,u=.2):!n&&l&&(c=.2,u=.8)}if(c>0&&a&&a.clone){let i=a.clone().multiplyScalar(c);if(e.translate(i.x,i.y,i.z),n&&t.colliderB.isStatic&&n.velocity&&n.velocity.clone&&h&&h.clone){let t=n.velocity.clone().projectOnVector(h.clone().negate());t.length()>0&&n.velocity.sub(t)}}if(u>0){let e=a.clone().multiplyScalar(-u);if(i.translate(e.x,e.y,e.z),l&&t.colliderA.isStatic){let t=l.velocity.clone().projectOnVector(h);t.length()>0&&l.velocity.sub(t)}}}}getApproximateRadius(t){switch(t.type){case"sphere":return t.radius;case"box":return .5*Math.max(t.size.x,t.size.y,t.size.z);case"capsule":case"cylinder":return Math.max(t.radius,.5*t.height);default:return .5}}queryColliders(t){return this.spatialHash.query(t).map(t=>t.entity)}queryCollidersRadius(t,e){return this.spatialHash.queryRadius(t,e).map(t=>t.entity)}queryCollidersPoint(t){return this.spatialHash.queryPoint(t).map(t=>t.entity)}getCollidersInLayer(t,e){return(e?this.spatialHash.query(e):Array.from(this.spatialHash.entityCells.keys()).map(t=>this.spatialHash.query(new s.Box3().setFromCenterAndSize(new s.Vector3,new s.Vector3(1e3,1e3,1e3))).find(e=>e.entity.id===t)).filter(Boolean)).filter(e=>{let i=e.entity.getComponent(o.YM);return i&&i.layer===t}).map(t=>t.entity)}getPerformanceStats(){return{collisionChecks:this.collisionChecks,actualCollisions:this.actualCollisions,activeCollisions:this.activeCollisions.size,spatialHashStats:this.spatialHash.getStats()}}onEntityRemoved(t){this.spatialHash.remove(t);let e=[];for(let i of(this.activeCollisions.forEach((i,s)=>{(i.entityA.id===t.id||i.entityB.id===t.id)&&e.push(s)}),e))this.activeCollisions.delete(i)}onDisable(){this.spatialHash.clear(),this.activeCollisions.clear(),this.collisionPairs.length=0}constructor(t=5){super(),this.requiredComponents=[n.w,o.YM],this.collisionPairs=[],this.activeCollisions=new Map,this.lastUpdateTime=0,this.collisionChecks=0,this.actualCollisions=0,this.priority=15,this.spatialHash=new h.k(t)}}},244:function(t,e,i){i.d(e,{b:function(){return u}});var s=i(9131),a=i(6862),n=i(3974),r=i(8001),o=i(73),h=i(246),l=i(7771),c=i(5050),d=i(6121);class u extends s.xP{shouldLogDamage(){let t=Date.now();return t-this.lastDamageLogTime>this.damageLogThrottle&&(this.lastDamageLogTime=t,!0)}setEnemyDamageCallback(t){this.onEnemyDamageCallback=t}setPlayerDamageCallback(t){this.onPlayerDamageCallback=t}update(t,e){let i=Date.now()/1e3;this.updateHealthComponents(t,e,i),this.processDamageQueue(i),this.processHealQueue(i),this.handleDeathAndRespawn(t,i),this.damageNumberManager.cleanup(),this.damageQueue.length=0,this.healQueue.length=0,this.deadEntities.length=0}updateHealthComponents(t,e,i){for(let s of t){let t=s.getComponent(a.S);if(!t||!t.enabled)continue;t.update(e,i);let o=s.getComponent(n.W);o&&o.update(e);let h=s.getComponent(r.C);h&&h.updateFreezeStatus(i)}}processDamageQueue(t){for(let e of this.damageQueue)this.applyDamage(e,t)}processHealQueue(t){for(let e of this.healQueue)this.applyHealing(e,t)}applyDamage(t,e){let{target:s,damage:n,source:h,damageType:l}=t,d=s.getComponent(a.S);if(!d||!d.enabled)return;let u=i(2487).a;if("charge"===l){let t=s.getComponent(r.C),e=s.getComponent(u)||null;t?t.getDisplayName():e?e.getDisplayName():s.id}let m=s.getComponent(r.C);if(m&&this.onEnemyDamageCallback){let t=(0,c.g3)(n),e=t.damage;this.onEnemyDamageCallback(s.id.toString(),e);let i=s.getComponent(o.w);if(i){let s=i.getWorldPosition();s.y+=1.5,this.damageNumberManager.addDamageNumber(e,t.isCritical,s,l)}h&&h.id,this.getEntityDisplayName(s),t.isCritical;return}let p=s.getComponent(u);if(p){let t=(0,c.g3)(n),i=t.damage;if(d.takeDamage(i,e,s)){this.totalDamageDealt+=i;let a=s.getComponent(o.w);if(a){let e=a.getWorldPosition();e&&void 0!==e.x&&void 0!==e.y&&void 0!==e.z&&(e.y+=2,this.damageNumberManager.addDamageNumber(i,t.isCritical,e,l||"melee"))}this.shouldLogDamage()&&(h&&h.id,p.getDisplayName(),t.isCritical),d.isDead&&this.handleEntityDeath(s,h,e),this.triggerDamageEffects(s,i,h,l,t.isCritical)}return}if(!m&&this.onPlayerDamageCallback&&h&&h.id!==s.id){let t=(0,c.g3)(n);this.shouldLogDamage(),this.onPlayerDamageCallback(s.id.toString(),t.damage,l);let e=s.getComponent(o.w);if(e){let i=e.getWorldPosition();i&&void 0!==i.x&&void 0!==i.y&&void 0!==i.z&&(i.y+=1.5,"sabres_right"===l&&(i.x+=.3),this.damageNumberManager.addDamageNumber(t.damage,t.isCritical,i,l||"pvp"))}this.shouldLogDamage()&&(h&&h.id,s.id,t.isCritical);return}let g=(0,c.g3)(n),y=g.damage;if(d.takeDamage(y,e,s)){this.totalDamageDealt+=y;let t=s.getComponent(o.w);if(t){let e=t.getWorldPosition();e&&void 0!==e.x&&void 0!==e.y&&void 0!==e.z&&(e.y+=3,this.damageNumberManager.addDamageNumber(y,g.isCritical,e,l))}this.shouldLogDamage()&&(h&&h.id,this.getEntityDisplayName(s),g.isCritical),d.isDead&&this.handleEntityDeath(s,h,e),this.triggerDamageEffects(s,y,h,l,g.isCritical)}}applyHealing(t,e){let{target:i,amount:s,source:n}=t,r=i.getComponent(a.S);r&&r.enabled&&r.heal(s)&&(this.totalHealingDone+=s,n&&n.id,this.getEntityDisplayName(i),this.triggerHealingEffects(i,s,n))}handleEntityDeath(t,e,s){let a=t.getComponent(r.C);a&&(a.die(s||Date.now()/1e3),this.enemiesKilled++,e&&this.awardExperience(e,a.experienceReward),this.triggerDeathEffects(t,e));let n=i(2487).a,o=t.getComponent(n);o&&(o.die(s||Date.now()/1e3),this.triggerDeathEffects(t,e)),this.deadEntities.push(t)}handleDeathAndRespawn(t,e){for(let i of t){let t=i.getComponent(a.S),s=i.getComponent(r.C);t&&s&&s.isDead&&s.canRespawnNow(e)&&this.respawnEnemy(i,s,t)}}respawnEnemy(t,e,i){e.respawn(),i.revive(),this.triggerRespawnEffects(t)}triggerDamageEffects(t,e,i,s,a){if(t.getComponent(o.w),"projectile"===s&&i){var n,r;let e=i.getComponent(h.T);if(null==e?void 0:null===(r=e.mesh)||void 0===r?void 0:null===(n=r.userData)||void 0===n?void 0:n.isBarrageArrow){let e=t.getComponent(l.i);e&&e.slow(5e3,.5)}}}triggerHealingEffects(t,e,i){t.getComponent(o.w)}triggerDeathEffects(t,e){t.getComponent(o.w)}triggerRespawnEffects(t){t.getComponent(o.w)}awardExperience(t,e){}getEntityDisplayName(t){let e=t.getComponent(r.C);if(e)return e.getDisplayName();let s=i(2487).a,a=t.getComponent(s);return a?a.getDisplayName():"Entity ".concat(t.id)}queueDamage(t,e,i,s){this.damageQueue.push({target:t,damage:e,source:i,damageType:s,timestamp:Date.now()/1e3})}queueHealing(t,e,i){this.healQueue.push({target:t,amount:e,source:i,timestamp:Date.now()/1e3})}dealDamageImmediate(t,e,i,s){let n=t.getComponent(a.S);if(!n||!n.enabled)return!1;let r=(0,c.g3)(e),h=r.damage,l=Date.now()/1e3,d=n.takeDamage(h,l,t);if(d){this.totalDamageDealt+=h;let e=t.getComponent(o.w);if(e){let t=e.getWorldPosition();t.y+=1.5,this.damageNumberManager.addDamageNumber(h,r.isCritical,t,s)}n.isDead&&this.handleEntityDeath(t,i,l),this.triggerDamageEffects(t,h,i,s,r.isCritical)}return d}healImmediate(t,e,i){let s=t.getComponent(a.S);if(!s||!s.enabled)return!1;let n=s.heal(e);return n&&(this.totalHealingDone+=e,this.triggerHealingEffects(t,e,i)),n}isEntityDead(t){let e=t.getComponent(a.S);return!!e&&e.isDead}getEntityHealthRatio(t){let e=t.getComponent(a.S);return e?e.getHealthRatio():0}canEntityTakeDamage(t){let e=t.getComponent(a.S);return!!e&&!e.isDead&&!e.isInvulnerable}getCombatStats(){return{totalDamageDealt:this.totalDamageDealt,totalHealingDone:this.totalHealingDone,enemiesKilled:this.enemiesKilled,queuedDamageEvents:this.damageQueue.length,queuedHealEvents:this.healQueue.length}}resetStats(){this.totalDamageDealt=0,this.totalHealingDone=0,this.enemiesKilled=0}getDamageNumbers(){return this.damageNumberManager.getDamageNumbers()}removeDamageNumber(t){this.damageNumberManager.removeDamageNumber(t)}onDisable(){this.damageQueue.length=0,this.healQueue.length=0,this.deadEntities.length=0,this.damageNumberManager.clear(),this.resetStats()}constructor(t){super(),this.requiredComponents=[a.S],this.damageQueue=[],this.healQueue=[],this.deadEntities=[],this.totalDamageDealt=0,this.totalHealingDone=0,this.enemiesKilled=0,this.lastDamageLogTime=0,this.damageLogThrottle=100,this.world=t,this.damageNumberManager=new d.w,this.priority=25}}},7223:function(t,e,i){i.d(e,{s:function(){return w}});var s=i(1448),a=i(9131),n=i(73),r=i(7771),o=i(6862),h=i(8001),l=i(246),c=i(3478),d=i(244),u=i(7125),m=i(8815),p=i(6932),g=i(2465),y=i(7019),f=i(319);class w extends a.xP{setPlayer(t){this.playerEntity=t}update(t,e){if(!this.playerEntity)return;let i=this.playerEntity.getComponent(n.w),s=this.playerEntity.getComponent(r.i);i&&s&&("function"==typeof s.updateDebuffs&&s.updateDebuffs(),this.cleanupSunderStacks(),this.handleWeaponSwitching(),this.handleDashMovement(s,i),this.handleChargeMovement(s,i),s.isDashing||s.isCharging||s.isFrozen||this.isSkyfalling||this.handleMovementInput(s),this.handleCombatInput(i),this.updateDeflectBarrier(i))}handleMovementInput(t){if(!this.playerEntity)return;let e=this.playerEntity.getComponent(n.w);if(!e)return;this.checkForDashInput(t,e);let i=new s.Vector3(0,0,0),a=!1;if(this.inputManager.isKeyPressed("w")&&(i.z-=1,a=!0),this.inputManager.isKeyPressed("s")&&(i.z+=1,a=!0),this.inputManager.isKeyPressed("a")&&(i.x-=1,a=!0),this.inputManager.isKeyPressed("d")&&(i.x+=1,a=!0),i.length()>0&&i.normalize(),a){let e=new s.Vector3;this.camera.getWorldDirection(e);let a=new s.Vector3;a.crossVectors(e,new s.Vector3(0,1,0)).normalize();let n=new s.Vector3;n.crossVectors(new s.Vector3(0,1,0),a).normalize();let r=new s.Vector3;r.addScaledVector(a,i.x),r.addScaledVector(n,-i.z),r.normalize(),t.setMoveDirection(r,1)}else t.setMoveDirection(new s.Vector3(0,0,0),0);this.inputManager.isKeyPressed(" ")&&t.jump()}handleWeaponSwitching(){let t=Date.now()/1e3;!(t-this.lastWeaponSwitchTime<this.weaponSwitchCooldown)&&(this.inputManager.isKeyPressed("1")?this.currentWeapon!==u.v.SWORD&&(this.resetAllAbilityStates(),this.currentWeapon=u.v.SWORD,this.currentSubclass=u.p.DIVINITY,this.fireRate=this.swordFireRate,this.lastWeaponSwitchTime=t,this.swordComboStep=1):this.inputManager.isKeyPressed("2")?this.currentWeapon!==u.v.BOW&&(this.resetAllAbilityStates(),this.currentWeapon=u.v.BOW,this.currentSubclass=u.p.ELEMENTAL,this.fireRate=.225,this.lastWeaponSwitchTime=t):this.inputManager.isKeyPressed("3")?this.currentWeapon!==u.v.SCYTHE&&(this.resetAllAbilityStates(),this.currentWeapon=u.v.SCYTHE,this.currentSubclass=u.p.CHAOS,this.fireRate=this.scytheFireRate,this.lastWeaponSwitchTime=t):this.inputManager.isKeyPressed("4")?this.currentWeapon!==u.v.SABRES&&(this.resetAllAbilityStates(),this.currentWeapon=u.v.SABRES,this.currentSubclass=u.p.FROST,this.fireRate=this.sabresFireRate,this.lastWeaponSwitchTime=t):this.inputManager.isKeyPressed("5")&&this.currentWeapon!==u.v.RUNEBLADE&&(this.resetAllAbilityStates(),this.currentWeapon=u.v.RUNEBLADE,this.currentSubclass=u.p.ARCANE,this.fireRate=this.runebladeFireRate,this.lastWeaponSwitchTime=t,this.swordComboStep=1))}handleCombatInput(t){this.currentWeapon===u.v.BOW?this.handleBowInput(t):this.currentWeapon===u.v.SCYTHE?this.handleScytheInput(t):this.currentWeapon===u.v.SWORD?this.handleSwordInput(t):this.currentWeapon===u.v.SABRES?this.handleSabresInput(t):this.currentWeapon===u.v.RUNEBLADE&&this.handleRunebladeInput(t)}handleBowInput(t){if(!this.inputManager.isKeyPressed("r")||this.isViperStingCharging||this.isCharging||this.performViperSting(t),!this.inputManager.isKeyPressed("q")||this.isBarrageCharging||this.isCharging||this.isViperStingCharging||this.performBarrage(t),!this.inputManager.isKeyPressed("e")||this.isCharging||this.isViperStingCharging||this.isBarrageCharging||this.isCobraShotCharging||this.performCobraShot(t),this.inputManager.isMouseButtonPressed(0))this.isCharging||this.isViperStingCharging||this.isBarrageCharging||this.isCobraShotCharging||(this.isCharging=!0,this.chargeProgress=0),this.isViperStingCharging||this.isBarrageCharging||this.isCobraShotCharging||(this.chargeProgress=Math.min(this.chargeProgress+.0125,1));else if(this.isCharging){if(this.isViperStingCharging||this.isBarrageCharging||this.isCobraShotCharging){this.isCharging=!1,this.chargeProgress=0;return}let e=this.chargeProgress;this.fireProjectile(t),this.isCharging=!1,this.chargeProgress=0,this.triggerBowReleaseEffects(e)}}handleScytheInput(t){this.inputManager.isMouseButtonPressed(0)?(this.isCharging||(this.isCharging=!0,this.chargeProgress=0,console.log("⚡ Started charging scythe (spinning)")),this.chargeProgress+=.03,this.fireEntropicBoltProjectile(t)):this.isCharging&&(this.isCharging=!1,this.chargeProgress=0),this.inputManager.isKeyPressed("r")&&!this.isCharging&&this.fireCrossentropyBoltAbility(t),this.inputManager.isKeyPressed("q")&&!this.isCharging&&this.performReanimateAbility(t),this.inputManager.isKeyPressed("e")&&!this.isCharging&&this.performFrostNovaAbility(t)}fireProjectile(t){let e=Date.now()/1e3;if(e-this.lastFireTime<this.fireRate)return;this.lastFireTime=e;let i=new s.Vector3;this.camera.getWorldDirection(i),i.normalize();let a=new s.Vector3;a.crossVectors(i,new s.Vector3(0,1,0)).normalize();let n=new s.Matrix4;n.makeRotationAxis(a,Math.PI/6),i.applyMatrix4(n),i.normalize();let r=this.chargeProgress>=.7&&this.chargeProgress<=.98;this.chargeProgress>=1?this.createChargedArrowProjectile(t.position.clone(),i):r?this.createPerfectShotProjectile(t.position.clone(),i):(i.x,i.z,this.createProjectile(t.position.clone(),i))}fireEntropicBoltProjectile(t){let e=Date.now()/1e3;if(e-this.lastFireTime<this.scytheFireRate)return;this.lastFireTime=e;let i=new s.Vector3;this.camera.getWorldDirection(i),i.normalize();let a=new s.Vector3;a.crossVectors(i,new s.Vector3(0,1,0)).normalize();let n=new s.Matrix4;n.makeRotationAxis(a,Math.PI/6),i.applyMatrix4(n),i.normalize(),this.isCharging,this.createEntropicBoltProjectile(t.position.clone(),i)}fireCrossentropyBoltAbility(t){let e=Date.now()/1e3;if(e-this.lastCrossentropyTime<this.crossentropyFireRate)return;this.lastCrossentropyTime=e;let i=new s.Vector3;this.camera.getWorldDirection(i),i.normalize();let a=new s.Vector3;a.crossVectors(i,new s.Vector3(0,1,0)).normalize();let n=new s.Matrix4;n.makeRotationAxis(a,Math.PI/6),i.applyMatrix4(n),i.normalize(),this.createCrossentropyBoltProjectile(t.position.clone(),i)}createProjectile(t,e){if(!this.playerEntity)return;let i=this.world.queryEntities([n.w,o.S,c.YM]).filter(t=>{var e;return t.id!==this.playerEntity.id&&!(null===(e=t.getComponent(o.S))||void 0===e?void 0:e.isDead)}).length>0,s=void 0!==this.onProjectileCreatedCallback;if(!i&&!s)return;let a=t.clone();a.add(e.clone().multiplyScalar(1)),a.y+=.75;let r={speed:25,damage:10,lifetime:3,maxDistance:25,subclass:this.currentSubclass,level:this.currentLevel,opacity:1};this.projectileSystem.createProjectile(this.world,a,e,this.playerEntity.id,r),this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("regular_arrow",a,e,r)}createEntropicBoltProjectile(t,e){if(!this.playerEntity)return;let i=this.world.queryEntities([n.w,o.S,c.YM]).filter(t=>{var e;return t.id!==this.playerEntity.id&&!(null===(e=t.getComponent(o.S))||void 0===e?void 0:e.isDead)}).length>0,s=void 0!==this.onProjectileCreatedCallback;if(!i&&!s)return;let a=window.gameUI;if(a&&!a.canCastEntropicBolt())return;a&&a.consumeMana(10);let r=t.clone();r.add(e.clone().multiplyScalar(1)),r.y+=1;let h={speed:20,damage:20,lifetime:2,piercing:!1,explosive:!1,explosionRadius:0,subclass:this.currentSubclass,level:this.currentLevel,opacity:1};this.projectileSystem.createEntropicBoltProjectile(this.world,r,e,this.playerEntity.id,h),this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("entropic_bolt",r,e,h)}createCrossentropyBoltProjectile(t,e){if(!this.playerEntity)return;let i=window.gameUI;if(i&&!i.canCastCrossentropyBolt())return;i&&(i.consumeMana(40),console.log("⚔️ Consumed 40 mana for Crossentropy Bolt"));let s=t.clone();s.add(e.clone().multiplyScalar(1)),s.y+=1;let a={speed:15,damage:90,lifetime:2.5,piercing:!1,explosive:!1,explosionRadius:0,subclass:this.currentSubclass,level:this.currentLevel,opacity:1};this.projectileSystem.createCrossentropyBoltProjectile(this.world,s,e,this.playerEntity.id,a),this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("crossentropy_bolt",s,e,a)}performReanimateAbility(t){if(!this.playerEntity)return;let e=Date.now()/1e3;if(e-this.lastReanimateTime<1)return;this.lastReanimateTime=e;let i=window.gameUI;if(i&&i.getCurrentMana(),i&&!i.canCastReanimate())return;i&&(i.getCurrentMana(),i.consumeMana(20),i.getCurrentMana()),this.triggerReanimateEffect(t);let s=this.playerEntity.getComponent(o.S);s&&s.heal(30)}triggerReanimateEffect(t){this.onReanimateCallback&&this.onReanimateCallback(),t.position}performFrostNovaAbility(t){if(!this.playerEntity)return;let e=Date.now()/1e3;if(e-this.lastFrostNovaTime<this.frostNovaFireRate)return;let i=window.gameUI;if(i&&!i.canCastFrostNova())return;i&&i.consumeMana(50),this.lastFrostNovaTime=e;let a=t.getWorldPosition(),n=new s.Vector3;this.camera.getWorldDirection(n),n.normalize(),this.onFrostNovaCallback&&this.onFrostNovaCallback(a,n),this.freezeEnemiesInRadius(a,6,e),(0,p.triggerGlobalFrostNova)(a)}performCobraShot(t){if(!this.playerEntity)return;let e=Date.now()/1e3;if(e-this.lastCobraShotTime<this.cobraShotFireRate)return;let i=window.gameUI;if(i&&!i.canCastCobraShot())return;i&&i.consumeEnergy(40),this.isCobraShotCharging=!0,this.cobraShotChargeProgress=0,this.lastCobraShotTime=e;let s=Date.now(),a=setInterval(()=>{let e=Date.now()-s;this.cobraShotChargeProgress=Math.min(e/750,1),this.cobraShotChargeProgress>=1&&(clearInterval(a),this.fireCobraShot(t),this.isCobraShotCharging=!1,this.cobraShotChargeProgress=0)},16)}fireCobraShot(t){let e=t.getWorldPosition();e.y+=.825;let i=new s.Vector3;this.camera.getWorldDirection(i),i.normalize();let a=new s.Vector3;a.crossVectors(i,new s.Vector3(0,1,0)).normalize();let n=new s.Matrix4;n.makeRotationAxis(a,Math.PI/6),i.applyMatrix4(n),i.normalize();let r=e.clone();r.add(i.clone().multiplyScalar(1)),this.onCobraShotCallback&&this.onCobraShotCallback(r,i),(0,y.triggerGlobalCobraShot)(r,i),this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("cobra_shot_projectile",r,i,{speed:20,damage:29,lifetime:8,venomDuration:6})}freezeEnemiesInRadius(t,e,i){let s=this.world.getAllEntities(),a=0,r=0,l=window.localSocketId;s.forEach(s=>{var c;let u=s.getComponent(n.w),m=s.getComponent(o.S);if(!u||!m||m.isDead||s.id===(null===(c=this.playerEntity)||void 0===c?void 0:c.id))return;let g=u.position;if(t.distanceTo(g)<=e){let t=s.getComponent(h.C);if(t)t.freeze(6,i),a++,(0,p.addGlobalFrozenEnemy)(s.id.toString(),g);else{let t=window.serverPlayerEntities,e=null;if(t&&t.current&&t.current.forEach((t,i)=>{t===s.id&&(e=i)}),e&&e===l){console.log("⚠️ Skipping Frost Nova on local player ".concat(l));return}let i=this.world.getSystem(d.b);i&&this.playerEntity&&e&&(i.queueDamage(s,50,this.playerEntity,"frost_nova"),r++,this.onDebuffCallback&&(console.log("\uD83C\uDFAF Broadcasting freeze effect to player ".concat(e," (NOT local player ").concat(l,")")),this.onDebuffCallback(s.id,"frozen",6e3,g)))}}})}createChargedArrowProjectile(t,e){if(!this.playerEntity)return;let i=t.clone();i.add(e.clone().multiplyScalar(1)),i.y+=.5;let s={speed:35,damage:50,lifetime:2,piercing:!0,explosive:!1,subclass:this.currentSubclass,level:this.currentLevel,opacity:1};this.projectileSystem.createChargedArrowProjectile(this.world,i,e,this.playerEntity.id,s),this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("charged_arrow",i,e,s)}createPerfectShotProjectile(t,e){if(!this.playerEntity)return;let i=t.clone();i.add(e.clone().multiplyScalar(1)),i.y+=.5,this.projectileSystem.createChargedArrowProjectile(this.world,i,e,this.playerEntity.id,{speed:40,damage:75,lifetime:6,piercing:!0,explosive:!1,subclass:this.currentSubclass,level:this.currentLevel,opacity:1}),this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("perfect_shot",i,e,{speed:40,damage:75,lifetime:6,piercing:!0,subclass:this.currentSubclass,level:this.currentLevel,opacity:1})}setWeaponSubclass(t){this.currentSubclass=t}setBowReleaseCallback(t){this.onBowReleaseCallback=t}setDivineStormCallback(t){this.onDivineStormCallback=t}setProjectileCreatedCallback(t){this.onProjectileCreatedCallback=t}setViperStingCallback(t){this.onViperStingCallback=t}setBarrageCallback(t){this.onBarrageCallback=t}setReanimateCallback(t){this.onReanimateCallback=t}setFrostNovaCallback(t){this.onFrostNovaCallback=t}setCobraShotCallback(t){this.onCobraShotCallback=t}setChargeCallback(t){this.onChargeCallback=t}setDeflectCallback(t){this.onDeflectCallback=t}setSkyfallCallback(t){this.onSkyfallCallback=t}setBackstabCallback(t){this.onBackstabCallback=t}setSunderCallback(t){this.onSunderCallback=t}setSmiteCallback(t){this.onSmiteCallback=t}setDeathGraspCallback(t){this.onDeathGraspCallback=t}setConsumeManaCallback(t){this.onConsumeManaCallback=t}setCheckManaCallback(t){this.onCheckManaCallback=t}setDebuffCallback(t){this.onDebuffCallback=t}triggerBowReleaseEffects(t){this.onBowReleaseCallback&&this.onBowReleaseCallback(t,t>=.75&&t<=.98)}setWeaponLevel(t){this.currentLevel=t}getCurrentWeaponConfig(){return{weapon:this.currentWeapon,subclass:this.currentSubclass,level:this.currentLevel}}getCurrentWeapon(){return this.currentWeapon}getCurrentSubclass(){return this.currentSubclass}isWeaponCharging(){return this.isCharging}getChargeProgress(){return this.chargeProgress}isViperStingChargingActive(){return this.isViperStingCharging}getViperStingChargeProgress(){return this.viperStingChargeProgress}isBarrageChargingActive(){return this.isBarrageCharging}getBarrageChargeProgress(){return this.barrageChargeProgress}isCobraShotChargingActive(){return this.isCobraShotCharging}getCobraShotChargeProgress(){return this.cobraShotChargeProgress}isWeaponSwinging(){return this.isSwinging}getSwordComboStep(){return this.swordComboStep}isDivineStormActive(){return this.isDivineStorming}isChargeActive(){return this.isSwordCharging}isDeflectActive(){return this.isDeflecting}isSkyfallActive(){return this.isSkyfalling}isBackstabActive(){return this.isBackstabbing}isSunderActive(){return this.isSundering}isSmiteActive(){return this.isSmiting}isDeathGraspActive(){return this.isDeathGrasping}handleSwordInput(t){!this.inputManager.isMouseButtonPressed(0)||this.isSwinging||this.isDivineStorming||this.isSwordCharging||this.isDeflecting||this.performSwordMeleeAttack(t),!this.inputManager.isKeyPressed("r")||this.isDivineStorming||this.isSwinging||this.isSwordCharging||this.isDeflecting||this.performDivineStorm(t),!this.inputManager.isKeyPressed("e")||this.isSwordCharging||this.isDivineStorming||this.isSwinging||this.isDeflecting||this.performCharge(t),!this.inputManager.isKeyPressed("q")||this.isDeflecting||this.isDivineStorming||this.isSwinging||this.isSwordCharging||this.performDeflect(t),Date.now()/1e3-this.lastSwordAttackTime>this.swordComboResetTime&&(this.swordComboStep=1)}handleRunebladeInput(t){!this.inputManager.isMouseButtonPressed(0)||this.isSwinging||this.isSmiting||this.isDeathGrasping||this.performRunebladeMeleeAttack(t),!this.inputManager.isKeyPressed("e")||this.isSmiting||this.isSwinging||this.isDeathGrasping||this.performSmite(t),!this.inputManager.isKeyPressed("q")||this.isDeathGrasping||this.isSmiting||this.isSwinging||this.performDeathGrasp(t),Date.now()/1e3-this.lastSwordAttackTime>this.swordComboResetTime&&(this.swordComboStep=1)}performSwordMeleeAttack(t){let e=Date.now()/1e3;e-this.lastFireTime<this.swordFireRate||(this.lastFireTime=e,this.lastSwordAttackTime=e,this.isSwinging=!0,this.performMeleeDamage(t))}performRunebladeMeleeAttack(t){let e=Date.now()/1e3;e-this.lastFireTime<this.runebladeFireRate||(this.lastFireTime=e,this.lastSwordAttackTime=e,this.isSwinging=!0,this.performMeleeDamage(t))}performSmite(t){if(this.currentWeapon!==u.v.RUNEBLADE)return;let e=Date.now()/1e3;if(e-this.lastSmiteTime<this.smiteCooldown||this.isSmiting)return;let i=window.gameUI;if(i&&!i.canCastSmite()){console.log("⚡ Smite: Not enough mana to cast (need 35)");return}if(this.lastSmiteTime=e,this.isSmiting=!0,i){let t=i.getCurrentMana();i.consumeMana(35);let e=i.getCurrentMana();console.log("⚡ Smite: Consumed 35 mana. Mana: ".concat(t," -> ").concat(e))}let a=t.position.clone(),n=new s.Vector3;this.camera.getWorldDirection(n),n.normalize();let r=a.clone().add(n.clone().multiplyScalar(2.5));console.log("⚡ Smite: Damage detection delegated to visual component"),this.onSmiteCallback&&this.onSmiteCallback(r,n,t=>{t&&(console.log("⚡ Smite: Damage detected by visual component, triggering healing"),this.performSmiteHealing())}),setTimeout(()=>{this.isSmiting=!1},900)}performSmiteDamage(t){if(!this.playerEntity)return!1;let e=!1;return this.world.getAllEntities().forEach(i=>{var s;if(i.id===(null===(s=this.playerEntity)||void 0===s?void 0:s.id))return;let a=i.getComponent(n.w),r=i.getComponent(o.S);if(!a||!r||r.isDead)return;let h=t.distanceTo(a.position);if(h<=3){let t=this.world.getSystem(d.b);t&&this.playerEntity?(t.queueDamage(i,80,this.playerEntity,"smite"),e=!0,console.log("⚡ Smite dealt ".concat(80," damage to entity ").concat(i.id," at distance ").concat(h.toFixed(2)))):console.log("⚡ Smite: Could not find CombatSystem or playerEntity to deal damage")}}),e}performSmiteHealing(){if(!this.playerEntity){console.log("⚡ Smite: No player entity available for healing");return}let t=this.playerEntity.getComponent(o.S);if(t){let e=t.currentHealth,i=t.maxHealth;t.heal(20)?console.log("⚡ Smite SUCCESSFULLY healed player for 20 HP! Health: ".concat(e," -> ").concat(t.currentHealth,"/").concat(i)):console.log("⚡ Smite: Player already at full health (".concat(t.currentHealth,"/").concat(i,") - no healing needed"))}else{console.log("⚡ Smite: CRITICAL ERROR - Could not find health component for player entity ".concat(this.playerEntity.id));try{let t=window.gameUI;t&&"function"==typeof t.gainHealth&&(t.gainHealth(20),console.log("⚡ Smite: FALLBACK healing through gameUI - healed for 20 HP"))}catch(t){console.log("⚡ Smite: Could not heal through fallback method either")}}}performDeathGrasp(t){if(this.currentWeapon!==u.v.RUNEBLADE)return;let e=Date.now()/1e3;if(e-this.lastDeathGraspTime<this.deathGraspCooldown||this.isDeathGrasping)return;let i=window.gameUI;if(i&&!i.canCastDeathGrasp()){console.log("\uD83D\uDC80 DeathGrasp: Not enough mana to cast (need 25)");return}if(this.lastDeathGraspTime=e,this.isDeathGrasping=!0,i){let t=i.getCurrentMana();i.consumeMana(25);let e=i.getCurrentMana();console.log("\uD83D\uDC80 DeathGrasp: Consumed 25 mana. Mana: ".concat(t," -> ").concat(e))}let a=t.position.clone(),n=new s.Vector3;this.camera.getWorldDirection(n),n.normalize(),this.onDeathGraspCallback&&this.onDeathGraspCallback(a,n),setTimeout(()=>{this.isDeathGrasping=!1},1200)}onSwordSwingComplete(){this.isSwinging&&(this.isSwinging=!1,this.swordComboStep=this.swordComboStep%3+1)}onSmiteComplete(){this.isSmiting&&(this.isSmiting=!1)}onDeathGraspComplete(){this.isDeathGrasping&&(this.isDeathGrasping=!1)}handleSabresInput(t){!this.inputManager.isMouseButtonPressed(0)||this.isSwinging||this.isSkyfalling||this.isSundering||this.performSabresMeleeAttack(t),!this.inputManager.isKeyPressed("q")||this.isSwinging||this.isSkyfalling||this.isSundering||this.performBackstab(t),!this.inputManager.isKeyPressed("e")||this.isSwinging||this.isSkyfalling||this.isSundering||this.performSunder(t),!this.inputManager.isKeyPressed("r")||this.isSkyfalling||this.isSundering||this.performSkyfall(t),this.isSkyfalling&&this.updateSkyfallMovement(t),this.isBackstabbing&&this.updateBackstabState(t),this.isSundering&&this.updateSunderState(t)}performSabresMeleeAttack(t){let e=Date.now()/1e3;e-this.lastFireTime<this.sabresFireRate||(this.lastFireTime=e,console.log("⚔️ Sabres dual attack initiated"),this.isSwinging=!0,this.performSabresMeleeDamage(t))}onSabresSwingComplete(){this.isSwinging&&(console.log("⚔️ Sabres dual swing completed"),this.isSwinging=!1)}performSabresMeleeDamage(t){Date.now();let e=this.world.getAllEntities().filter(t=>t.hasComponent(o.S)&&t.hasComponent(n.w)&&t!==this.playerEntity),i=Math.PI/2,a=new s.Vector3;for(let s of(this.camera.getWorldDirection(a),a.normalize(),e)){let e=s.getComponent(n.w),r=s.getComponent(o.S);if(!e||!r||r.isDead)continue;let h=e.position.clone().sub(t.position);if(h.length()>3.8||(h.normalize(),Math.acos(Math.max(-1,Math.min(1,a.dot(h))))>i/2))continue;let l=this.world.getSystem(d.b);l&&(l.queueDamage(s,19,this.playerEntity||void 0),setTimeout(()=>{r.isDead||l.queueDamage(s,23,this.playerEntity||void 0)},100))}}performSkyfall(t){var e;let i=Date.now()/1e3;if(i-this.lastSkyfallTime<this.skyfallCooldown)return;let a=window.gameUI;if(!a||!a.canCastSkyfall())return;a.consumeEnergy(40),this.isSkyfalling=!0,this.skyfallPhase="ascending",this.skyfallStartTime=i,this.lastSkyfallTime=i,this.skyfallStartPosition.copy(t.position);let n=null===(e=this.playerEntity)||void 0===e?void 0:e.getComponent(r.i);if(n&&(this.skyfallOriginalGravity=n.gravity,this.skyfallTargetHeight=t.position.y+1.4*n.jumpForce,n.velocity.y=2*n.jumpForce,n.gravity=0),this.onSkyfallCallback){let e=new s.Vector3;this.camera.getWorldDirection(e),this.onSkyfallCallback(t.position,e)}}updateSkyfallMovement(t){var e;let i=Date.now()/1e3,s=null===(e=this.playerEntity)||void 0===e?void 0:e.getComponent(r.i);if(!s)return;let a=i-this.skyfallStartTime;switch(this.skyfallPhase){case"ascending":(t.position.y>=this.skyfallTargetHeight||s.velocity.y<=0)&&(this.skyfallPhase="descending",s.velocity.y=0,s.gravity=30*this.skyfallOriginalGravity);break;case"descending":t.position.y<=this.skyfallStartPosition.y+.5&&(this.skyfallPhase="landing",this.performSkyfallLanding(t));break;case"landing":this.completeSkyfallAbility(t)}a>4&&this.completeSkyfallAbility(t)}performSkyfallLanding(t){let e=this.world.getAllEntities(),i=t.position;for(let t of e){if(t===this.playerEntity)continue;let e=t.getComponent(o.S),s=t.getComponent(n.w);if(e&&s&&!e.isDead&&4>=i.distanceTo(s.position)){let e=this.world.getSystem(d.b);e&&e.queueDamage(t,125,this.playerEntity||void 0)}}}completeSkyfallAbility(t){var e;this.isSkyfalling=!1,this.skyfallPhase="none";let i=null===(e=this.playerEntity)||void 0===e?void 0:e.getComponent(r.i);i&&(i.gravity=this.skyfallOriginalGravity,i.velocity.y=0)}updateBackstabState(t){Date.now()/1e3-this.backstabStartTime>=this.backstabDuration&&(this.isBackstabbing=!1)}performSunder(t){let e=Date.now()/1e3;if(e-this.lastSunderTime<this.sunderCooldown)return;let i=window.gameUI;i&&i.canCastSunder()&&(i.consumeEnergy(35),this.lastSunderTime=e,this.isSundering=!0,this.sunderStartTime=e,this.performSunderDamage(t))}updateSunderState(t){Date.now()/1e3-this.sunderStartTime>=this.sunderDuration&&(this.isSundering=!1)}performSunderDamage(t){let e=this.world.getAllEntities(),i=t.position,a=new s.Vector3;this.camera.getWorldDirection(a),a.normalize();let r=Date.now()/1e3;for(let l of e){if(l===this.playerEntity)continue;let e=l.getComponent(o.S),c=l.getComponent(n.w);if(!e||!c||e.isDead||i.distanceTo(c.position)>3.5)continue;let u=new s.Vector3().subVectors(c.position,i).normalize();if(a.dot(u)<Math.cos(Math.PI/4))continue;let{damage:m,stackCount:p,isStunned:y}=this.applySunderStack(l.id,r),f=this.world.getSystem(d.b);if(f&&(f.queueDamage(l,m,this.playerEntity,"sunder"),y)){let t=l.getComponent(h.C);if(t&&(t.freeze(4,r),(0,g.Ei)(l.id.toString(),c.position)),this.onDebuffCallback){let t=window.localSocketId,e=window.serverPlayerEntities,i=null;e&&e.current&&e.current.forEach((t,e)=>{t===l.id&&(i=e)}),i&&i!==t?(console.log("\uD83C\uDFAF Broadcasting stun effect to player ".concat(i," (NOT local player ").concat(t,")")),this.onDebuffCallback(l.id,"stunned",4e3,c.position)):console.log("⚠️ Skipping stun broadcast - would target local player ".concat(t," or invalid target ").concat(i))}}this.onSunderCallback&&this.onSunderCallback(t.position,a,m,p)}}applySunderStack(t,e){let i=this.sunderStacks.get(t);(!i||e-i.lastApplied>10)&&(i={stacks:0,lastApplied:e,duration:10});let s=[60,70,80,90][Math.min(i.stacks,3)],a=!1,n=i.stacks;return i.stacks<3?(n=i.stacks+1,this.sunderStacks.set(t,{stacks:n,lastApplied:e,duration:10})):(a=!0,n=0,this.sunderStacks.set(t,{stacks:0,lastApplied:e,duration:10})),{damage:s,stackCount:n,isStunned:a}}cleanupSunderStacks(){let t=Date.now()/1e3;for(let[e,i]of Array.from(this.sunderStacks.entries()))t-i.lastApplied>10&&this.sunderStacks.delete(e)}resetAllAbilityStates(){this.isSkyfalling=!1,this.skyfallPhase="none",this.isBackstabbing=!1,this.isSundering=!1,this.isDivineStorming=!1,this.isSwordCharging=!1,this.isDeflecting=!1,this.sunderStacks.clear()}performBackstab(t){let e=Date.now()/1e3;if(e-this.lastBackstabTime<this.backstabCooldown)return;let i=window.gameUI;if(i&&i.canCastBackstab()){if(i.consumeEnergy(60),this.lastBackstabTime=e,this.isBackstabbing=!0,this.backstabStartTime=e,this.onBackstabCallback){let e=new s.Vector3;this.camera.getWorldDirection(e),this.onBackstabCallback(t.position,e,75,!1)}this.performBackstabDamage(t)}}performBackstabDamage(t){let e=this.world.getAllEntities(),i=t.position,a=new s.Vector3;for(let t of(this.camera.getWorldDirection(a),a.normalize(),e)){if(t===this.playerEntity)continue;let e=t.getComponent(o.S),r=t.getComponent(n.w);if(!e||!r||e.isDead||i.distanceTo(r.position)>4.25)continue;let h=new s.Vector3().subVectors(r.position,i).normalize();if(a.dot(h)<Math.cos(Math.PI/3))continue;let l=75,c=window.pvpPlayers,u=window.localSocketId;if(c&&u){let t=null;for(let[e,i]of c)if(e!==u&&.5>new s.Vector3(i.position.x,i.position.y,i.position.z).distanceTo(r.position)){t=i;break}if(t){let e=new s.Vector3(Math.sin(t.rotation.y),0,Math.cos(t.rotation.y)).normalize(),a=new s.Vector3().subVectors(i,r.position).normalize();-.3>e.dot(a)&&(l=175)}}let m=this.world.getSystem(d.b);m&&m.queueDamage(t,l,this.playerEntity,"backstab")}}performMeleeDamage(t){let e=this.world.getAllEntities(),i=t.position,a=new s.Vector3;this.camera.getWorldDirection(a),a.normalize();let r=Math.PI/2,h=45;if(this.currentWeapon===u.v.SWORD)switch(this.swordComboStep){case 1:h=40;break;case 2:h=45;break;case 3:h=55}else if(this.currentWeapon===u.v.RUNEBLADE)switch(this.swordComboStep){case 1:h=30;break;case 2:h=35;break;case 3:h=45}let l=this.world.getSystem(d.b),c=0;if(e.forEach(t=>{var e;let s=t.getComponent(n.w),d=t.getComponent(o.S);if(!s||!d||t.id===(null===(e=this.playerEntity)||void 0===e?void 0:e.id))return;let u=s.position.clone().sub(i);4.5>=u.length()&&(u.normalize(),a.angleTo(u)<=r/2&&l&&this.playerEntity&&(l.queueDamage(t,h,this.playerEntity,"melee"),c++))}),c>0){let t=window.gameUI;if(t){let e=Math.min(5*c,5);t.gainRage(e)}}}checkForDashInput(t,e){for(let{key:i,direction:a}of[{key:"w",direction:new s.Vector3(0,0,-1)},{key:"s",direction:new s.Vector3(0,0,1)},{key:"a",direction:new s.Vector3(-1,0,0)},{key:"d",direction:new s.Vector3(1,0,0)}])if(this.inputManager.checkDoubleTap(i)){this.inputManager.getDoubleTapDebugInfo(i);let s=this.getWorldSpaceDirection(a),n=Date.now()/1e3;t.startDash(s,e.position,n)&&this.inputManager.resetDoubleTap(i);break}}handleDashMovement(t,e){if(!t.isDashing)return;let i=Date.now()/1e3,s=t.updateDash(i);s.newPosition&&(29>=s.newPosition.length()?e.position.copy(s.newPosition):t.cancelDash())}handleChargeMovement(t,e){if(!t.isCharging)return;let i=Date.now()/1e3;if(this.chargeStoppedByCollision){t.cancelCharge();return}let s=t.updateCharge(i);if(s.newPosition){let i=s.newPosition.length(),a=this.checkPillarCollision(s.newPosition);i>29?(t.cancelCharge(),this.onChargeComplete()):a.hasCollision?(console.warn("Charge cancelled: would collide with pillar at [".concat(a.pillarCenter.toArray().join(", "),"]")),t.cancelCharge(),this.onChargeComplete()):this.chargeStoppedByCollision||e.position.copy(s.newPosition)}(s.isComplete||this.chargeStoppedByCollision)&&(console.log("⚔️ Charge movement completed"),this.onChargeComplete())}checkPillarCollision(t){for(let e of this.PILLAR_POSITIONS){let i=new s.Vector3(t.x,0,t.z),a=new s.Vector3(e.x,0,e.z);if(i.distanceTo(a)<this.PILLAR_RADIUS){let t=i.clone().sub(a).normalize();return 0===t.length()&&t.set(1,0,0),{hasCollision:!0,normal:t,pillarCenter:e.clone()}}}return{hasCollision:!1,normal:new s.Vector3,pillarCenter:new s.Vector3}}getWorldSpaceDirection(t){let e=new s.Vector3;this.camera.getWorldDirection(e);let i=new s.Vector3;i.crossVectors(e,new s.Vector3(0,1,0)).normalize();let a=new s.Vector3;a.crossVectors(new s.Vector3(0,1,0),i).normalize();let n=new s.Vector3;return n.addScaledVector(i,t.x),n.addScaledVector(a,-t.z),n.normalize(),n}performDivineStorm(t){let e=window.gameUI;if(e&&!e.canCastDivineStorm())return;let i=Date.now()/1e3;if(i-this.lastDivineStormTime<this.divineStormCooldown)return;let a=e?e.getCurrentRage():40;e&&e.consumeAllRage();let n=1e3+500*Math.floor(a/10);if(this.isDivineStorming=!0,this.lastDivineStormTime=i,this.onDivineStormCallback){let e=new s.Vector3;this.camera.getWorldDirection(e),e.normalize(),this.onDivineStormCallback(t.position.clone(),e,n)}setTimeout(()=>{this.isDivineStorming=!1},n)}performCharge(t){let e=Date.now()/1e3;if(e-this.lastChargeTime<this.chargeCooldown)return;if(this.isSwordCharging=!0,this.lastChargeTime=e,this.chargeStoppedByCollision=!1,this.onChargeCallback){let e=new s.Vector3;this.camera.getWorldDirection(e),e.normalize(),this.onChargeCallback(t.position.clone(),e)}let i=window.gameUI;if(i&&i.gainRage(20),this.playerEntity){let i=this.playerEntity.getComponent(r.i);if(i){let a=new s.Vector3;this.camera.getWorldDirection(a),a.y=0,a.normalize(),i.startCharge(a,t.position,e)&&this.scheduleChargeDamage(t,a,e)}}}scheduleChargeDamage(t,e,i){this.chargeHitEntities.clear(),this.chargeStoppedByCollision=!1;let a=setInterval(()=>{let l=Date.now()/1e3;if(!this.isSwordCharging||l-i>.6||this.chargeStoppedByCollision){clearInterval(a);return}let u=this.world.getAllEntities(),m=t.position,p=!1,g=window.pvpPlayers||new Map,y=window.localSocketId;if(g.forEach((t,i)=>{if(i===y)return;let a=1e3*i.length+i.charCodeAt(0);if(this.chargeHitEntities.has(a))return;let n=new s.Vector3(t.position.x,t.position.y,t.position.z);1.9>=m.distanceTo(n)&&t.health>0&&(this.chargeHitEntities.add(a),p=!0,this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("sword_charge_hit",m.clone(),e.clone(),{damage:40,targetId:i,hitPosition:{x:n.x,y:n.y,z:n.z}}))}),u.forEach(t=>{var i;if(t.id===(null===(i=this.playerEntity)||void 0===i?void 0:i.id)||this.chargeHitEntities.has(t.id))return;let s=t.getComponent(n.w),a=t.getComponent(o.S),r=t.getComponent(c.YM),l=t.getComponent(h.C);if(l?l.getDisplayName():t.id,!s||!a||a.isDead)return;let u=s.position;if(m.distanceTo(u)<=(r?r.radius+1:2.5)){this.chargeHitEntities.add(t.id),p=!0;let i=this.world.getSystem(d.b);if(i&&this.playerEntity){i.queueDamage(t,40,this.playerEntity,"charge");let s=t.getComponent(h.C);s?s.getDisplayName():t.id,this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("sword_charge_hit",m.clone(),e.clone(),{damage:40,targetId:t.id,hitPosition:{x:u.x,y:u.y,z:u.z}})}}}),p){if(this.chargeStoppedByCollision=!0,this.playerEntity){let t=this.playerEntity.getComponent(r.i);t&&t.cancelCharge()}clearInterval(a),this.onChargeComplete()}},50)}onChargeComplete(){this.isSwordCharging=!1}performDeflect(t){let e=Date.now()/1e3;if(!(e-this.lastDeflectTime<this.deflectCooldown)){if(this.isDeflecting=!0,this.lastDeflectTime=e,this.onDeflectCallback){let e=new s.Vector3;this.camera.getWorldDirection(e),e.normalize(),this.onDeflectCallback(t.position.clone(),e)}this.setupDeflectBarrier(t),setTimeout(()=>{this.onDeflectComplete()},1e3*this.deflectDuration)}}performViperSting(t){let e=Date.now()/1e3;if(e-this.lastViperStingTime<this.viperStingFireRate)return;let i=window.gameUI;if(i&&!i.canCastViperSting())return;i&&i.consumeEnergy(60),this.isViperStingCharging=!0,this.viperStingChargeProgress=0,this.lastViperStingTime=e;let s=Date.now(),a=setInterval(()=>{let e=Date.now()-s;this.viperStingChargeProgress=Math.min(e/1e3,1),this.viperStingChargeProgress>=1&&(clearInterval(a),this.fireViperSting(t),this.isViperStingCharging=!1,this.viperStingChargeProgress=0)},16)}fireViperSting(t){let e=t.getWorldPosition();e.y+=.825;let i=new s.Vector3;this.camera.getWorldDirection(i),i.normalize();let a=new s.Vector3;a.crossVectors(i,new s.Vector3(0,1,0)).normalize();let n=new s.Matrix4;n.makeRotationAxis(a,Math.PI/6),i.applyMatrix4(n),i.normalize();let r=e.clone();r.add(i.clone().multiplyScalar(1)),this.onViperStingCallback&&this.onViperStingCallback(e,i),(0,f.triggerGlobalViperSting)(),this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("viper_sting_projectile",r,i,{speed:16,damage:61,lifetime:5,isReturning:!1})}performBarrage(t){let e=Date.now()/1e3;if(e-this.lastBarrageTime<this.barrageFireRate){console.log("⏰ Barrage on cooldown for ".concat((this.barrageFireRate-(e-this.lastBarrageTime)).toFixed(1),"s"));return}let i=window.gameUI;if(i&&!i.canCastBarrage())return;i&&i.consumeEnergy(40),this.isBarrageCharging=!0,this.barrageChargeProgress=0,this.lastBarrageTime=e;let s=Date.now(),a=setInterval(()=>{let e=Date.now()-s;this.barrageChargeProgress=Math.min(e/500,1),this.barrageChargeProgress>=1&&(clearInterval(a),this.fireBarrage(t),this.isBarrageCharging=!1,this.barrageChargeProgress=0)},16)}fireBarrage(t){let e=t.getWorldPosition();e.y+=.825;let i=new s.Vector3;this.camera.getWorldDirection(i);let a=new s.Vector3;a.crossVectors(i,new s.Vector3(0,1,0)).normalize();let n=new s.Matrix4;n.makeRotationAxis(a,Math.PI/6),i.applyMatrix4(n),i.normalize(),[0,Math.PI/12,-Math.PI/12,Math.PI/6,-Math.PI/6].forEach(t=>{let a=i.clone(),n=new s.Matrix4().makeRotationY(t);a.applyMatrix4(n),a.normalize();let r=e.clone();r.add(a.clone().multiplyScalar(1));let o={speed:22,damage:30,lifetime:8,maxDistance:25,piercing:!1,subclass:this.currentSubclass,level:1,opacity:1},h=this.projectileSystem.createProjectile(this.world,r,a,this.playerEntity.id,o).getComponent(l.T);(null==h?void 0:h.mesh)&&(h.mesh.userData.isBarrageArrow=!0,h.mesh.userData.isRegularArrow=!1),this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("barrage_projectile",r,a,o)}),this.onBarrageCallback&&this.onBarrageCallback(e,i)}setupDeflectBarrier(t){let e=t.getWorldPosition(),i=new s.Vector3(0,0,0);if(this.playerEntity){let t=this.playerEntity.getComponent(r.i);if(t&&t.inputStrength>.1){let e=t.moveDirection;if(e.length()>.1){let t=Math.atan2(e.x,e.z);i.y=t}}else{let t=new s.Vector3;this.camera.getWorldDirection(t),i.y=Math.atan2(t.x,t.z)}}this.deflectBarrier.activate(e,i,this.playerEntity||void 0)}updateDeflectBarrier(t){if(this.deflectBarrier.isBarrierActive()){let e=t.getWorldPosition(),i=new s.Vector3(0,0,0);if(this.playerEntity){let t=this.playerEntity.getComponent(r.i);if(t&&t.inputStrength>.1){let e=t.moveDirection;if(e.length()>.1){let t=Math.atan2(e.x,e.z);i.y=t}}else{let t=new s.Vector3;this.camera.getWorldDirection(t),i.y=Math.atan2(t.x,t.z)}}this.deflectBarrier.updatePosition(e,i)}}onDeflectComplete(){this.isDeflecting=!1,this.deflectBarrier.deactivate()}getWeaponSwitchCooldown(){let t=Date.now()/1e3;return{current:Math.max(0,this.weaponSwitchCooldown-(t-this.lastWeaponSwitchTime)),max:this.weaponSwitchCooldown}}getAbilityCooldowns(){let t=Date.now()/1e3,e={};return this.currentWeapon===u.v.SWORD?(e.Q={current:Math.max(0,this.deflectCooldown-(t-this.lastDeflectTime)),max:this.deflectCooldown,isActive:this.isDeflecting},e.E={current:Math.max(0,this.chargeCooldown-(t-this.lastChargeTime)),max:this.chargeCooldown,isActive:this.isSwordCharging},e.R={current:Math.max(0,this.divineStormCooldown-(t-this.lastDivineStormTime)),max:this.divineStormCooldown,isActive:this.isDivineStorming}):this.currentWeapon===u.v.BOW?(e.Q={current:Math.max(0,this.barrageFireRate-(t-this.lastBarrageTime)),max:this.barrageFireRate,isActive:this.isBarrageCharging},e.E={current:Math.max(0,this.cobraShotFireRate-(t-this.lastCobraShotTime)),max:this.cobraShotFireRate,isActive:!1},e.R={current:Math.max(0,this.viperStingFireRate-(t-this.lastViperStingTime)),max:this.viperStingFireRate,isActive:this.isViperStingCharging}):this.currentWeapon===u.v.SCYTHE?(e.Q={current:Math.max(0,1-(t-this.lastReanimateTime)),max:1,isActive:!1},e.E={current:Math.max(0,this.frostNovaFireRate-(t-this.lastFrostNovaTime)),max:this.frostNovaFireRate,isActive:!1},e.R={current:Math.max(0,this.crossentropyFireRate-(t-this.lastCrossentropyTime)),max:this.crossentropyFireRate,isActive:!1}):this.currentWeapon===u.v.SABRES?(e.Q={current:Math.max(0,this.backstabCooldown-(t-this.lastBackstabTime)),max:this.backstabCooldown,isActive:this.isBackstabbing},e.E={current:Math.max(0,this.sunderCooldown-(t-this.lastSunderTime)),max:this.sunderCooldown,isActive:this.isSundering},e.R={current:Math.max(0,this.skyfallCooldown-(t-this.lastSkyfallTime)),max:this.skyfallCooldown,isActive:this.isSkyfalling}):this.currentWeapon===u.v.RUNEBLADE&&(e.Q={current:Math.max(0,this.deathGraspCooldown-(t-this.lastDeathGraspTime)),max:this.deathGraspCooldown,isActive:this.isDeathGrasping},e.E={current:Math.max(0,this.smiteCooldown-(t-this.lastSmiteTime)),max:this.smiteCooldown,isActive:this.isSmiting}),e}constructor(t,e,i,a){super(),this.requiredComponents=[n.w,r.i],this.playerEntity=null,this.lastFireTime=0,this.lastCrossentropyTime=0,this.lastReanimateTime=0,this.lastViperStingTime=0,this.lastFrostNovaTime=0,this.lastCobraShotTime=0,this.fireRate=.2,this.swordFireRate=.9,this.runebladeFireRate=.75,this.sabresFireRate=.6,this.scytheFireRate=.375,this.crossentropyFireRate=2,this.viperStingFireRate=2.5,this.frostNovaFireRate=12,this.cobraShotFireRate=2.5,this.currentWeapon=u.v.BOW,this.currentSubclass=u.p.ELEMENTAL,this.currentLevel=1,this.isCharging=!1,this.chargeProgress=0,this.isSwinging=!1,this.isViperStingCharging=!1,this.viperStingChargeProgress=0,this.isBarrageCharging=!1,this.barrageChargeProgress=0,this.lastBarrageTime=0,this.barrageFireRate=5,this.isCobraShotCharging=!1,this.cobraShotChargeProgress=0,this.swordComboStep=1,this.lastSwordAttackTime=0,this.swordComboResetTime=1,this.isDivineStorming=!1,this.lastDivineStormTime=0,this.divineStormCooldown=8,this.isSwordCharging=!1,this.lastChargeTime=0,this.chargeCooldown=8,this.isDeflecting=!1,this.lastDeflectTime=0,this.deflectCooldown=6,this.deflectDuration=3,this.isSkyfalling=!1,this.skyfallPhase="none",this.lastSkyfallTime=0,this.skyfallCooldown=5,this.skyfallStartTime=0,this.skyfallStartPosition=new s.Vector3,this.skyfallTargetHeight=0,this.skyfallOriginalGravity=0,this.lastBackstabTime=0,this.backstabCooldown=1.5,this.isBackstabbing=!1,this.backstabStartTime=0,this.backstabDuration=1,this.lastSunderTime=0,this.sunderCooldown=1.125,this.isSundering=!1,this.sunderStartTime=0,this.sunderDuration=1,this.sunderStacks=new Map,this.lastSmiteTime=0,this.smiteCooldown=2,this.isSmiting=!1,this.lastDeathGraspTime=0,this.deathGraspCooldown=5,this.isDeathGrasping=!1,this.lastWeaponSwitchTime=0,this.weaponSwitchCooldown=1.5,this.PILLAR_POSITIONS=[new s.Vector3(0,0,-5),new s.Vector3(-4.25,0,2.5),new s.Vector3(4.25,0,2.5)],this.PILLAR_RADIUS=.7,this.chargeHitEntities=new Set,this.chargeStoppedByCollision=!1,this.camera=t,this.inputManager=e,this.world=i,this.projectileSystem=a,this.deflectBarrier=new m.l(i),this.priority=5}}},4451:function(t,e,i){i.d(e,{C:function(){return h}});var s=i(1448),a=i(9131),n=i(73),r=i(6862),o=i(6776);class h extends a.Kg{update(t,e){for(let i of t){let t=i.getComponent(n.w),s=i.getComponent(r.S),a=i.getComponent(o.T);if(!t.enabled||!s.enabled||!a.enabled)continue;let h=t.getWorldPosition(),l=this.camera.position;a.updateHealthBar(s.getHealthRatio(),l,h,e)}}render(t,e){}onEntityAdded(t){let e=t.getComponent(o.T);e&&this.scene.add(e.getGroup())}onEntityRemoved(t){let e=t.getComponent(o.T);e&&(this.scene.remove(e.getGroup()),e.dispose())}onDisable(){let t=[];for(let e of(this.scene.traverse(e=>{e instanceof s.Group&&e.userData.isHealthBar&&t.push(e)}),t))this.scene.remove(e)}constructor(t,e){super(),this.requiredComponents=[n.w,r.S,o.T],this.scene=t,this.camera=e,this.priority=100}}},8079:function(t,e,i){i.d(e,{Z:function(){return h}});var s=i(1448),a=i(9131),n=i(73),r=i(2762),o=i(7771);class h extends a.xP{update(t,e){for(let e of(this.currentTime=performance.now(),t)){let t=e.getComponent(n.w),i=e.getComponent(r.K),s=e.getComponent(o.i);(null==t?void 0:t.enabled)&&(null==i?void 0:i.enabled)&&(!s||!s.canMove)&&this.interpolateEntity(t,i)}}render(t,e){this.update(t,e)}interpolateEntity(t,e){let i=e.getInterpolatedTransform(this.currentTime);t.position.copy(i.position),t.quaternion.copy(i.rotation),t.rotation.setFromQuaternion(t.quaternion),t.matrixNeedsUpdate=!0}addServerState(t,e,i,s){let a=t.getComponent(r.K);a&&a.addServerState(e,i,s)}getInterpolationStats(t){let e=t.getComponent(r.K);return e?e.getBufferStats():null}clearInterpolationBuffer(t){let e=t.getComponent(r.K);e&&e.clearBuffer()}setInterpolationDelay(t,e){console.warn("Interpolation delay is currently fixed in InterpolationBuffer component")}getCurrentRenderTime(){return this.currentTime}static hermiteInterpolate(t,e,i,a,n){let r=n*n,o=r*n,h=new s.Vector3;return h.addScaledVector(t,2*o-3*r+1),h.addScaledVector(i,o-2*r+n),h.addScaledVector(e,-2*o+3*r),h.addScaledVector(a,o-r),h}static catmullRomInterpolate(t,e,i,a,n){let r=n*n,o=r*n,h=new s.Vector3;return h.addScaledVector(t,-.5*o+r-.5*n),h.addScaledVector(e,1.5*o-2.5*r+1),h.addScaledVector(i,-1.5*o+2*r+.5*n),h.addScaledVector(a,.5*o-.5*r),h}static bezierInterpolate(t,e,i,a,n){let r=1-n,o=n*n,h=r*r,l=new s.Vector3;return l.addScaledVector(t,h*r),l.addScaledVector(e,3*h*n),l.addScaledVector(i,3*r*o),l.addScaledVector(a,o*n),l}static smoothStepInterpolate(t,e,i){return new s.Vector3().lerpVectors(t,e,i*i*(3-2*i))}static smootherStepInterpolate(t,e,i){return new s.Vector3().lerpVectors(t,e,i*i*i*(i*(6*i-15)+10))}constructor(){super(),this.requiredComponents=[n.w,r.K],this.currentTime=0,this.priority=20}}},5773:function(t,e,i){i.d(e,{F:function(){return o}});var s=i(1448),a=i(9131),n=i(73),r=i(7771);class o extends a.FU{update(t,e){for(let i of t){let t=i.getComponent(n.w),s=i.getComponent(r.i);t&&s&&t.enabled&&s.enabled&&s.canMove&&("function"==typeof s.updateDebuffs&&s.updateDebuffs(),this.updateMovement(t,s,e))}}fixedUpdate(t,e){for(let i of t){let t=i.getComponent(n.w),s=i.getComponent(r.i);t&&s&&t.enabled&&s.enabled&&s.canMove&&this.applyPhysics(t,s,e)}}updateMovement(t,e,i){let a=e.velocity.clone().multiplyScalar(i),n=t.position.clone(),r=n.clone().add(a),o=new s.Vector3(r.x,0,r.z).length(),h=this.checkPillarCollision(r);if(o>=29){let e=new s.Vector3(n.x,0,n.z),i=e.clone().normalize(),r=new s.Vector3(-i.z,0,i.x),o=new s.Vector3(a.x,0,a.z),h=r.multiplyScalar(o.dot(r)),l=e.add(h);l.normalize().multiplyScalar(29),t.setPosition(l.x,n.y+a.y,l.z)}else if(h.hasCollision){let i=this.calculatePillarSliding(n,a,h);t.setPosition(i.x,i.y,i.z);let s=e.velocity.clone().projectOnVector(h.normal);e.velocity.sub(s.multiplyScalar(.5))}else t.translate(a.x,a.y,a.z);t.matrixNeedsUpdate=!0}checkPillarCollision(t){for(let e of this.PILLAR_POSITIONS){let i=new s.Vector3(t.x,0,t.z),a=new s.Vector3(e.x,0,e.z);if(i.distanceTo(a)<this.PILLAR_RADIUS){let t=i.clone().sub(a).normalize();return 0===t.length()&&t.set(1,0,0),{hasCollision:!0,normal:t,pillarCenter:e.clone()}}}return{hasCollision:!1,normal:new s.Vector3,pillarCenter:new s.Vector3}}calculatePillarSliding(t,e,i){let a=new s.Vector3(-i.normal.z,0,i.normal.x),n=e.clone().projectOnVector(a),r=t.clone().add(n),o=new s.Vector3(i.pillarCenter.x,0,i.pillarCenter.z),h=new s.Vector3(r.x,0,r.z);if(h.distanceTo(o)<this.PILLAR_RADIUS){let t=h.clone().sub(o).normalize();0===t.length()&&t.set(1,0,0);let e=o.clone().add(t.multiplyScalar(this.PILLAR_RADIUS));r.x=e.x,r.z=e.z}return r}applyPhysics(t,e,i){if(e.applyGravity(i),e.inputStrength>0){let t=e.getEffectiveMaxSpeed(),i=e.moveDirection.clone();i.multiplyScalar(t*e.inputStrength),e.velocity.x=i.x,e.velocity.z=i.z}else e.velocity.x=0,e.velocity.z=0;e.velocity.add(e.acceleration.clone().multiplyScalar(i)),e.acceleration.set(0,0,0),t.position.y<=.5&&e.velocity.y<=0?(t.position.y=.5,e.velocity.y=0,e.isGrounded=!0):e.isGrounded=!1}constructor(){super(),this.requiredComponents=[n.w,r.i],this.PILLAR_POSITIONS=[new s.Vector3(0,0,-5),new s.Vector3(-4.25,0,2.5),new s.Vector3(4.25,0,2.5)],this.PILLAR_RADIUS=.7,this.priority=15}}},2972:function(t,e,i){i.d(e,{c:function(){return d}});var s=i(1448),a=i(9131),n=i(73),r=i(1168),o=i(6862),h=i(246),l=i(3478),c=i(6520);class d extends a.xP{setCombatSystem(t){this.combatSystem=t}update(t,e){for(let i of(this.projectilesToDestroy.length=0,t)){let t=i.getComponent(n.w),s=i.getComponent(r.W);if(t.enabled&&s.enabled){if(s.update(e),s.isExpired()){this.projectilesToDestroy.push(i.id);continue}this.moveProjectile(t,s,e),this.updateHomingDirection(i,s,e),this.checkCollisions(i,t,s),this.checkWorldBounds(i,t)}}for(let t of this.projectilesToDestroy)this.world.destroyEntity(t)}moveProjectile(t,e,i){this.tempVector.copy(e.velocity).multiplyScalar(i),t.translate(this.tempVector.x,this.tempVector.y,this.tempVector.z),t.matrixNeedsUpdate=!0}updateHomingDirection(t,e,i){if(!e.targetEntityId||e.homingStrength<=0)return;let a=this.world.getEntity(e.targetEntityId);if(!a){e.disableHoming();return}let r=a.getComponent(n.w);if(!r){e.disableHoming();return}let o=t.getComponent(n.w);if(!o)return;let h=!0===t.isTowerProjectile,l=o.position,c=r.position;this.tempVector.copy(c).sub(l);let d=this.tempVector.length();if(d<(h?.05:.1)&&!h)return;this.tempVector.normalize();let u=e.velocity.clone().normalize();if(h&&d<.3){let t=this.tempVector.clone(),a=Math.min(u.angleTo(t),e.maxTurnRate*i*2);if(a>.001){let i=new s.Vector3;i.crossVectors(u,t).normalize();let n=u.clone();n.applyAxisAngle(i,a),e.velocity.copy(n).multiplyScalar(e.speed)}}else{let t=h?Math.min(e.homingStrength+.1,1):e.homingStrength,a=new s.Vector3;a.lerpVectors(u,this.tempVector,t);let n=Math.min(u.angleTo(a),e.maxTurnRate*i);if(n>.001){let t=new s.Vector3;t.crossVectors(u,a).normalize();let i=u.clone();i.applyAxisAngle(t,n),e.velocity.copy(i).multiplyScalar(e.speed)}}}checkCollisions(t,e,i){var s,a,r,c;let d=e.position,u=t.getComponent(h.T);if((null==u?void 0:null===(a=u.mesh)||void 0===a?void 0:null===(s=a.userData)||void 0===s?void 0:s.isBarrageArrow)||(null==u?void 0:null===(c=u.mesh)||void 0===c?void 0:null===(r=c.userData)||void 0===r?void 0:r.projectileType)==="viper_sting")return;let m=this.world.queryEntities([n.w,o.S,l.YM]);if(0!==m.length)for(let e of m){if(e.id===t.id||e.id===i.owner){e.id,i.owner;continue}if(!i.canHitTarget(e.id))continue;let s=e.getComponent(n.w),a=e.getComponent(o.S),r=e.getComponent(l.YM);if(a.isDead||r.layer!==l.aB.ENEMY&&r.layer!==l.aB.PLAYER||r.layer===l.aB.PLAYER&&e.id===i.owner)continue;let h=s.getWorldPosition(),c=r.radius;if(d.distanceToSquared(h)<=(.2+c)**2&&(this.handleHit(t,e,i,a),!i.piercing)){this.projectilesToDestroy.push(t.id);break}}}handleHit(t,e,i,s){if(i.addHitTarget(e.id),this.combatSystem){var a,n,r,o;let s=t.getComponent(h.T),l=null==s?void 0:null===(n=s.mesh)||void 0===n?void 0:null===(a=n.userData)||void 0===a?void 0:a.isCrossentropyBolt,c=null==s?void 0:null===(o=s.mesh)||void 0===o?void 0:null===(r=o.userData)||void 0===r?void 0:r.isEntropicBolt,d="projectile";l?d="crossentropy":c&&(d="entropic"),this.combatSystem.queueDamage(e,i.damage,t,d)}else{let t=Date.now()/1e3;s.takeDamage(i.damage,t,e)}i.explosionRadius>0&&this.handleExplosion(t,i)}handleExplosion(t,e){let i=t.getComponent(n.w).position;for(let t of(this.world.emitEvent("explosion",{position:i.clone(),color:new s.Color("#00ff44"),size:e.explosionRadius,duration:.5}),this.world.queryEntities([n.w,o.S]))){if(t.id===e.owner)continue;let s=t.getComponent(n.w),a=t.getComponent(o.S),r=i.distanceTo(s.position);if(r<=e.explosionRadius){let i=1-r/e.explosionRadius,s=Math.floor(e.damage*i);if(s>0){let e=Date.now()/1e3;a.takeDamage(s,e,t)}}}}checkWorldBounds(t,e){let i=e.position;if(i.lengthSq()>1600){this.projectilesToDestroy.push(t.id);return}i.y<-10&&this.projectilesToDestroy.push(t.id)}createChargedArrowProjectile(t,e,i,a,o){let c=t.createEntity(),d=t.createComponent(n.w);d.position.copy(e),c.addComponent(d);let u=t.createComponent(r.W);u.speed=(null==o?void 0:o.speed)||35,u.damage=(null==o?void 0:o.damage)||25,u.maxLifetime=(null==o?void 0:o.lifetime)||5,u.owner=a,u.setDirection(i),(null==o?void 0:o.piercing)&&u.setPiercing(!0),(null==o?void 0:o.explosive)&&(null==o?void 0:o.explosionRadius)&&u.setExplosive(o.explosionRadius),c.addComponent(u);let m=t.createComponent(h.T),p=new s.SphereGeometry(.15,8,8),g=new s.MeshStandardMaterial({color:"#ffaa00",emissive:"#ffaa00",emissiveIntensity:3,transparent:!0,opacity:.1}),y=new s.Mesh(p,g);y.userData.isChargedArrow=!0,y.userData.direction=i.clone(),y.userData.subclass=null==o?void 0:o.subclass,y.userData.level=null==o?void 0:o.level,y.userData.opacity=(null==o?void 0:o.opacity)||1,m.mesh=y,c.addComponent(m);let f=t.createComponent(l.YM);return f.radius=.15,f.layer=l.aB.PROJECTILE,c.addComponent(f),c}createCrossentropyBoltProjectile(t,e,i,a,o){let l=t.createEntity(),c=t.createComponent(n.w);c.position.copy(e),l.addComponent(c);let d=t.createComponent(r.W);d.speed=(null==o?void 0:o.speed)||20,d.damage=(null==o?void 0:o.damage)||30,d.maxLifetime=(null==o?void 0:o.lifetime)||1.75,d.owner=a,d.setDirection(i),(null==o?void 0:o.piercing)&&d.setPiercing(!0),(null==o?void 0:o.explosive)&&(null==o?void 0:o.explosionRadius)&&d.setExplosive(o.explosionRadius),l.addComponent(d);let u=t.createComponent(h.T),m=new s.SphereGeometry(.28,8,8),p=new s.MeshStandardMaterial({color:"#00ff44",emissive:"#00ff44",emissiveIntensity:0,transparent:!0,opacity:0}),g=new s.Mesh(m,p);return g.userData.isCrossentropyBolt=!0,g.userData.projectileEntity=l,g.userData.direction=i.clone(),u.mesh=g,"function"==typeof u.setCastShadow&&u.setCastShadow(!1),l.addComponent(u),this.world.notifyEntityAdded(l),l}createEntropicBoltProjectile(t,e,i,a,o){let l=t.createEntity(),c=t.createComponent(n.w);c.position.copy(e),l.addComponent(c);let d=t.createComponent(r.W);d.speed=(null==o?void 0:o.speed)||20,d.damage=(null==o?void 0:o.damage)||20,d.maxLifetime=(null==o?void 0:o.lifetime)||1.75,d.owner=a,d.setDirection(i),(null==o?void 0:o.piercing)&&d.setPiercing(!0),(null==o?void 0:o.explosive)&&(null==o?void 0:o.explosionRadius)&&d.setExplosive(o.explosionRadius),l.addComponent(d);let u=t.createComponent(h.T),m=new s.SphereGeometry(.15,6,6),p=new s.MeshStandardMaterial({color:"#00ff44",emissive:"#00ff44",emissiveIntensity:0,transparent:!0,opacity:0}),g=new s.Mesh(m,p);return g.userData.isEntropicBolt=!0,g.userData.projectileEntity=l,g.userData.direction=i.clone(),u.mesh=g,"function"==typeof u.setCastShadow&&u.setCastShadow(!1),l.addComponent(u),this.world.notifyEntityAdded(l),l}createProjectile(t,e,i,a,o){let c=t.createEntity(),d=t.createComponent(n.w);d.position.copy(e),c.addComponent(d);let u=t.createComponent(r.W);u.speed=(null==o?void 0:o.speed)||20,u.damage=(null==o?void 0:o.damage)||5,u.maxLifetime=(null==o?void 0:o.lifetime)||2,u.owner=a,u.setDirection(i),u.setStartPosition(e),(null==o?void 0:o.maxDistance)!==void 0&&u.setMaxDistance(o.maxDistance),(null==o?void 0:o.piercing)&&u.setPiercing(!0),(null==o?void 0:o.explosive)&&(null==o?void 0:o.explosionRadius)&&u.setExplosive(o.explosionRadius),c.addComponent(u);let m=t.createComponent(h.T),p=new s.SphereGeometry(.15,8,8),g=new s.MeshStandardMaterial({color:"#ffaa00",emissive:"#ffaa00",emissiveIntensity:3,transparent:!0,opacity:.1}),y=new s.Mesh(p,g);y.userData.isRegularArrow=!0,y.userData.direction=i.clone(),y.userData.subclass=null==o?void 0:o.subclass,y.userData.level=null==o?void 0:o.level,y.userData.opacity=(null==o?void 0:o.opacity)||1,y.userData.projectileType=null==o?void 0:o.projectileType,m.mesh=y,"function"==typeof m.setCastShadow&&m.setCastShadow(!1),c.addComponent(m);let f=t.createComponent(l.YM);return f.radius=.15,f.layer=l.aB.PROJECTILE,c.addComponent(f),this.world.notifyEntityAdded(c),c}getPoolStats(){return{vector3:this.vector3Pool.getPoolSize()}}onDisable(){this.vector3Pool.clear()}constructor(t){super(),this.requiredComponents=[n.w,r.W],this.combatSystem=null,this.projectilesToDestroy=[],this.tempVector=new s.Vector3,this.tempVector2=new s.Vector3,this.world=t,this.priority=20,this.vector3Pool=new c.L(()=>new s.Vector3,t=>t.set(0,0,0),100)}}},3842:function(t,e,i){i.d(e,{K:function(){return o}});var s=i(1448),a=i(9131),n=i(73),r=i(246);class o extends a.Kg{update(t,e){for(let i of t){let t=i.getComponent(n.w),s=i.getComponent(r.T);t.enabled&&s.enabled&&("function"==typeof s.updateAnimations&&s.updateAnimations(e),this.updateEntityMesh(i,t,s))}}render(t,e){for(let e of t){let t=e.getComponent(n.w),i=e.getComponent(r.T);t.enabled&&i.enabled&&this.updateEntityTransform(e,t,i)}this.renderer.render(this.scene,this.camera)}updateEntityMesh(t,e,i){let s=this.meshMap.get(t.id);if(!s&&i.mesh){this.meshMap.set(t.id,i.mesh),this.scene.add(i.mesh);return}if(!s&&i.geometry&&i.material){let e=i.createMesh();e&&(this.meshMap.set(t.id,e),this.scene.add(e))}else s&&"function"==typeof i.updateMesh&&i.updateMesh()}updateEntityTransform(t,e,i){let a=this.meshMap.get(t.id);a&&(e.updateMatrix(),a.position.copy(e.position),a.quaternion.copy(e.quaternion),a.scale.copy(e.scale),i.isInstanced&&a instanceof s.Mesh&&i.updateInstanceMatrix(e.matrix))}onEntityAdded(t){let e=t.getComponent(r.T);if(e){if(e.mesh){this.meshMap.set(t.id,e.mesh),this.scene.add(e.mesh);return}if(e.geometry&&e.material){let i=e.createMesh();i&&(this.meshMap.set(t.id,i),this.scene.add(i))}}}onEntityRemoved(t){let e=this.meshMap.get(t.id);e&&(this.scene.remove(e),this.meshMap.delete(t.id));let i=t.getComponent(r.T);i&&"function"==typeof i.dispose&&i.dispose()}getMesh(t){return this.meshMap.get(t)}getScene(){return this.scene}getCamera(){return this.camera}getRenderer(){return this.renderer}addLight(t){this.scene.add(t)}removeLight(t){this.scene.remove(t)}addObject(t){this.scene.add(t)}removeObject(t){this.scene.remove(t)}setFog(t){this.scene.fog=t}setBackground(t){this.scene.background=t}enableShadows(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0];this.renderer.shadowMap.enabled=t,this.renderer.shadowMap.type=s.PCFSoftShadowMap}setPixelRatio(t){this.renderer.setPixelRatio(t||window.devicePixelRatio)}setSize(t,e){this.renderer.setSize(t,e),this.camera instanceof s.PerspectiveCamera&&(this.camera.aspect=t/e,this.camera.updateProjectionMatrix())}dispose(){for(let[t,e]of Array.from(this.meshMap.entries()))this.scene.remove(e);this.meshMap.clear(),this.renderer.dispose()}constructor(t,e,i){super(),this.requiredComponents=[n.w,r.T],this.meshMap=new Map,this.scene=t,this.camera=e,this.renderer=i,this.priority=1e3}}},967:function(t,e,i){i.d(e,{J:function(){return d}});var s=i(1448),a=i(9131),n=i(73),r=i(7771),o=i(6862),h=i(2487),l=i(3478),c=i(2115);class d extends a.xP{setCombatSystem(t){this.combatSystem=t}setWaveCompleteCallback(t){this.onWaveComplete=t}updatePlayerPosition(t,e){this.playerPositions.set(t,e.clone())}updateTowerPosition(t,e){this.towerPositions.set(t,e.clone())}update(t,e){let i=Date.now()/1e3;for(let s of(this.unitsToDestroy.length=0,t)){let t=s.getComponent(n.w),a=s.getComponent(h.a),r=s.getComponent(o.S);if(t&&a&&r){if(a.isExpired(i)){this.waveUnits.delete(s.id),this.unitsToDestroy.push(s.id);continue}if(r.isDead&&!a.isDead){a.die(i),this.waveUnits.delete(s.id),this.unitsToDestroy.push(s.id);continue}a.isActive&&!a.isDead&&this.updateUnitBehavior(s,t,a,i,e)}}for(let t of(this.checkWaveCompletion(i),this.handleUnitSpawning(i),this.unitsToDestroy))this.world.destroyEntity(t)}updateUnitBehavior(t,e,i,s,a){i.canSearchForTargets(s)&&(this.findTargetForUnit(i,e.position),i.updateTargetSearch(s)),!i.currentTarget&&i.targetPosition&&this.moveTowardsPosition(t,e,i,a),i.currentTarget&&i.canAttack(s)&&this.handleUnitAttack(t,i,s)}findTargetForUnit(t,e){let i=this.findEnemyUnits(t.ownerId,e);if(i.length>0){let s=this.findClosestEntity(i,e);if(s){t.setTarget(s.id);return}}let s=this.findEnemyTower(t.ownerId,e);if(s){t.setTarget(s.id);return}t.clearTarget()}findEnemyUnits(t,e){let i=[];for(let e of this.world.queryEntities([n.w,h.a,o.S,l.YM])){let s=e.getComponent(h.a),a=e.getComponent(o.S),n=e.getComponent(l.YM);s&&a&&n&&!a.isDead&&s.isActive&&s.ownerId!==t&&n.layer===l.aB.ENEMY&&i.push(e)}return i}findEnemyTower(t,e){for(let e of this.world.queryEntities([n.w,c.N,o.S,l.YM])){let i=e.getComponent(c.N),s=e.getComponent(o.S),a=e.getComponent(l.YM);if(i&&s&&a&&!s.isDead&&i.isActive&&i.ownerId!==t&&a.layer===l.aB.ENEMY)return e}return null}findClosestEntity(t,e){let i=null,s=1/0;for(let a of t){let t=a.getComponent(n.w);if(!t)continue;let r=e.distanceTo(t.position);r<s&&(s=r,i=a)}return i}moveTowardsPosition(t,e,i,a){if(!i.targetPosition)return;let n=e.position,o=new s.Vector3(i.targetPosition.x,i.targetPosition.y,i.targetPosition.z);this.tempVector.copy(o).sub(n);let h=this.tempVector.length();if(h<.5){i.targetPosition=null;return}this.tempVector.normalize();let l=i.moveSpeed*a;if(l<h){let t=n.clone().add(this.tempVector.multiplyScalar(l));e.setPosition(t.x,t.y,t.z)}else e.setPosition(o.x,o.y,o.z),i.targetPosition=null;let c=t.getComponent(r.i);c&&c.velocity.copy(this.tempVector).multiplyScalar(i.moveSpeed)}handleUnitAttack(t,e,i){if(!e.currentTarget)return;let s=this.world.getEntity(e.currentTarget);if(!s){e.clearTarget();return}let a=s.getComponent(n.w),r=s.getComponent(o.S);if(!a||!r){e.clearTarget();return}let h=t.getComponent(n.w);if(h){if(h.position.distanceTo(a.position)>e.attackRange||r.isDead){e.clearTarget();return}this.combatSystem?this.combatSystem.queueDamage(s,e.attackDamage,t,"melee"):r.takeDamage(e.attackDamage,i,s),e.performAttack(i)}}checkWaveCompletion(t){this.currentWaveId&&0===this.waveUnits.size&&t-this.lastWaveCompletionTime>=30&&(console.log("\uD83C\uDFAF Wave ".concat(this.currentWaveId," completed! Awarding experience to all players.")),this.onWaveComplete&&this.onWaveComplete(),this.lastWaveCompletionTime=t,this.currentWaveId=null)}handleUnitSpawning(t){for(let e of this.world.queryEntities([n.w,c.N,o.S])){let i=e.getComponent(c.N),s=e.getComponent(n.w);i&&s&&i.isActive&&!i.isDead&&t-(this.lastSpawnTime.get(i.ownerId)||0)>=this.spawnInterval&&(this.spawnUnitsForTower(i,s.position,t),this.lastSpawnTime.set(i.ownerId,t))}}spawnUnitsForTower(t,e,i){this.currentWaveId||(this.currentWaveId="wave_".concat(i),this.waveStartTime=i,this.waveUnits.clear(),console.log("\uD83C\uDF0A Starting new wave: ".concat(this.currentWaveId)));let a=this.findOpposingTowerPosition(t.ownerId);a||(a=e.clone().add(new s.Vector3(0,0,20)));for(let s=0;s<2;s++){let n=this.spawnUnit(t.ownerId,e,a,s,i);n&&this.waveUnits.add(n.id)}}findOpposingTowerPosition(t){for(let e of this.world.queryEntities([n.w,c.N,o.S])){let i=e.getComponent(c.N),s=e.getComponent(n.w);if(i&&s&&i.ownerId!==t)return s.position.clone()}return null}spawnUnit(t,e,i,a,c){let d=this.world.createEntity(),u="".concat(t,"_unit_").concat(c,"_").concat(a),m=new s.Vector3((a-.5)*2,0,0),p=e.clone().add(m),g=this.world.createComponent(n.w);g.setPosition(p.x,p.y,p.z),d.addComponent(g);let y=this.world.createComponent(h.a);y.ownerId=t,y.unitId=u,y.targetPosition={x:i.x,y:i.y,z:i.z},y.summonTime=c,d.addComponent(y);let f=new o.S(y.maxHealth);d.addComponent(f);let w=this.world.createComponent(r.i);w.maxSpeed=y.moveSpeed,w.friction=.9,d.addComponent(w);let S=this.world.createComponent(l.YM);return S.type=l.F5.SPHERE,S.radius=.5,S.layer=l.aB.ENEMY,S.setOffset(0,.6,0),d.addComponent(S),this.world.notifyEntityAdded(d),d}getUnitCount(t){return this.world.queryEntities([n.w,h.a,o.S]).filter(e=>{let i=e.getComponent(h.a),s=e.getComponent(o.S);return i&&s&&i.ownerId===t&&i.isActive&&!i.isDead&&!s.isDead}).length}getAllUnits(){return this.world.queryEntities([n.w,h.a,o.S])}getUnitsByOwner(t){return this.getAllUnits().filter(e=>{let i=e.getComponent(h.a);return i&&i.ownerId===t})}onDisable(){this.lastSpawnTime.clear(),this.playerPositions.clear(),this.towerPositions.clear(),this.waveUnits.clear(),this.currentWaveId=null,this.onWaveComplete=void 0}constructor(t){super(),this.requiredComponents=[n.w,h.a,o.S],this.combatSystem=null,this.lastSpawnTime=new Map,this.spawnInterval=45,this.currentWaveId=null,this.waveUnits=new Set,this.waveStartTime=0,this.lastWaveCompletionTime=0,this.unitsToDestroy=[],this.playerPositions=new Map,this.towerPositions=new Map,this.tempVector=new s.Vector3,this.tempVector2=new s.Vector3,this.world=t,this.priority=15}}},3021:function(t,e,i){i.d(e,{R:function(){return d}});var s=i(1448),a=i(9131),n=i(73),r=i(6862),o=i(2115),h=i(2487),l=i(1168),c=i(3478);class d extends a.xP{setProjectileSystem(t){this.projectileSystem=t}setTowerAttackCallback(t){this.onTowerAttackCallback=t}setPlayerMapping(t,e){this.serverPlayerEntities=t,this.localSocketId=e}update(t,e){let i=Date.now()/1e3;for(let e of t){let t=e.getComponent(n.w),s=e.getComponent(o.N),a=e.getComponent(r.S);if(t&&s&&a){if(a.isDead&&!s.isDead){s.die(i);continue}if(s.isActive&&!s.isDead){if(s.canSearchForTargets(i)&&this.searchForTarget(e,t,s,i),s.currentTarget){let e=this.world.getEntity(s.currentTarget);this.isValidTarget(e||null,t,s)||s.clearTarget()}s.currentTarget&&s.canAttack(i)&&this.attackTarget(e,t,s,i)}}}}searchForTarget(t,e,i,s){i.updateTargetSearch(s);let a=this.world.queryEntities([n.w,r.S,c.YM]),o=null,h=1/0;for(let t of a){let s=t.getComponent(c.YM),a=t.getComponent(n.w);if(s&&a&&e.position.distanceTo(a.position),!this.isValidTarget(t,e,i))continue;let r=t.getComponent(n.w);if(!r)continue;let l=e.position.distanceTo(r.position);l<=i.targetSearchRange&&l<h&&(o=t,h=l)}o?i.setTarget(o.id):i.currentTarget&&i.clearTarget()}isValidTarget(t,e,i){if(!t)return!1;let s=t.getComponent(r.S),a=t.getComponent(n.w),l=t.getComponent(c.YM);if(!s||!a||!l||s.isDead||l.layer!==c.aB.PLAYER&&l.layer!==c.aB.ENEMY||t.hasComponent(o.N))return!1;let d=t.getComponent(h.a);if(d)return d.ownerId!==i.ownerId;if(this.localSocketId&&this.serverPlayerEntities.size>0){if(l.layer===c.aB.PLAYER)return i.ownerId!==this.localSocketId;if(l.layer===c.aB.ENEMY){let e=null;if(this.serverPlayerEntities.forEach((i,s)=>{i===t.id&&(e=s)}),e)return i.ownerId!==e}}return!0}attackTarget(t,e,i,s){let a=this.world.getEntity(i.currentTarget);if(!a){i.clearTarget();return}let r=a.getComponent(n.w);if(!r){i.clearTarget();return}this.tempVector2.copy(e.position),this.tempVector2.y+=2,this.tempVector.copy(r.position),this.tempVector.sub(this.tempVector2);let o=this.tempVector.length();if(o>i.attackRange){i.clearTarget();return}if(o<.5&&(this.tempVector.copy(r.position),this.tempVector.y+=.3,this.tempVector.sub(this.tempVector2)),this.tempVector.normalize(),this.projectileSystem){let e={speed:i.projectileSpeed,damage:i.attackDamage,lifetime:2,opacity:1},s=this.projectileSystem.createProjectile(this.world,this.tempVector2,this.tempVector,t.id,e),a=s.getComponent(l.W);if(a&&i.currentTarget){let t=this.world.getEntity(i.currentTarget),e=(null==t?void 0:t.getComponent(h.a))!==void 0;e?a.setHoming(i.currentTarget,1,8):a.setHoming(i.currentTarget,.95,6),a.maxTurnRate=e?12:8}s.getComponent(n.w)&&(s.isTowerProjectile=!0,s.towerOwnerId=i.ownerId)}if(this.onTowerAttackCallback){let t="player_".concat(i.currentTarget);this.onTowerAttackCallback(i.ownerId,t,this.tempVector2,this.tempVector)}i.performAttack(s)}getTowersByOwner(t){return this.world.queryEntities([n.w,o.N,r.S]).filter(e=>{let i=e.getComponent(o.N);return i&&i.ownerId===t})}getTowerCount(t){return this.getTowersByOwner(t).length}hasActiveTowers(t){return this.getTowersByOwner(t).some(t=>{let e=t.getComponent(o.N),i=t.getComponent(r.S);return e&&i&&e.isActive&&!e.isDead&&!i.isDead})}constructor(t){super(),this.requiredComponents=[n.w,o.N,r.S],this.projectileSystem=null,this.serverPlayerEntities=new Map,this.localSocketId=null,this.tempVector=new s.Vector3,this.tempVector2=new s.Vector3,this.world=t,this.priority=25}}}}]);