(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{2607:function(e,t,a){Promise.resolve().then(a.bind(a,6117))},6117:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return h}});var l=a(7437),n=a(2265),r=a(166),o=a(7125),s=a(4668),i=a(2295),d=a(946),u=a(4954);let c=(0,r.default)(()=>Promise.all([a.e(841),a.e(736)]).then(a.bind(a,3599)).then(e=>({default:e.Canvas})),{loadableGenerated:{webpack:()=>[3599]},ssr:!1,loading:()=>(0,l.jsx)("div",{className:"flex items-center justify-center h-screen text-white",children:"Loading 3D engine..."})}),m=(0,r.default)(()=>a.e(812).then(a.bind(a,8026)),{loadableGenerated:{webpack:()=>[8026]},ssr:!1,loading:()=>null}),p=(0,r.default)(()=>Promise.all([a.e(841),a.e(893),a.e(812),a.e(736),a.e(866)]).then(a.bind(a,9078)).then(e=>({default:e.PVPGameScene})),{loadableGenerated:{webpack:()=>[9078]},ssr:!1,loading:()=>null});function h(){let[e,t]=(0,n.useState)([]),[a,r]=(0,n.useState)({camera:null,size:{width:0,height:0}}),[h,y]=(0,n.useState)({playerHealth:200,maxHealth:200,playerShield:100,maxShield:100,currentWeapon:o.v.BOW,currentSubclass:o.p.ELEMENTAL}),[b,w]=(0,n.useState)(null),[x,g]=(0,n.useState)("menu"),[v,f]=(0,n.useState)(!1),[C,D]=(0,n.useState)("multiplayer"),j=e=>{window.handleDamageNumberComplete&&window.handleDamageNumberComplete(e)},S=(e,t)=>{r({camera:e,size:t})},k=e=>{y(e)},M=e=>{w(e)};return(0,l.jsx)(d.P,{children:(0,l.jsxs)("main",{className:"w-full h-screen bg-black relative",children:["menu"===x&&(0,l.jsx)("div",{className:"absolute inset-0 flex items-center justify-center z-50",children:(0,l.jsxs)("div",{className:"bg-black/95 p-8 rounded-xl border-2 border-green-500 text-white text-center",children:[(0,l.jsx)("h1",{className:"text-4xl font-bold mb-8 text-green-500",children:"AVERNUS"}),(0,l.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,l.jsx)("button",{className:"px-8 py-4 text-xl bg-green-500 text-white border-none rounded-lg cursor-pointer transition-all duration-300 font-bold hover:bg-green-600 hover:-translate-y-1",onClick:()=>g("singleplayer"),children:"Single Player"}),(0,l.jsx)("button",{className:"px-8 py-4 text-xl bg-red-500 text-white border-none rounded-lg cursor-pointer transition-all duration-300 font-bold hover:bg-red-600 hover:-translate-y-1",onClick:()=>{D("pvp"),f(!0)},children:"PVP"})]})]})}),v&&(0,l.jsx)(u.Z,{onJoinSuccess:()=>{f(!1),g(C)},currentWeapon:h.currentWeapon,currentSubclass:h.currentSubclass,gameMode:C}),(0,l.jsxs)(c,{camera:{position:[0,5,10],fov:75,near:.1,far:1e3},shadows:!0,gl:{antialias:!0,alpha:!1,powerPreference:"high-performance"},children:["singleplayer"===x&&(0,l.jsx)(m,{onDamageNumbersUpdate:t,onDamageNumberComplete:j,onCameraUpdate:S,onGameStateUpdate:k,onControlSystemUpdate:M}),"pvp"===x&&(0,l.jsx)(p,{onDamageNumbersUpdate:t,onDamageNumberComplete:j,onCameraUpdate:S,onGameStateUpdate:k,onControlSystemUpdate:M})]}),"menu"!==x&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"absolute top-4 left-4 text-white font-mono text-sm",children:[(0,l.jsx)("div",{children:"WASD - Move"}),(0,l.jsx)("div",{children:"Right Click + Drag - Look Around"}),(0,l.jsx)("div",{children:"Left Click - Attack/Fire"}),(0,l.jsx)("div",{children:"R - Special Ability"}),(0,l.jsx)("div",{children:"Space - Jump"}),(0,l.jsx)("div",{children:"Mouse Wheel - Zoom"}),(0,l.jsx)("div",{className:"mt-2 text-yellow-400",children:(0,l.jsx)("div",{children:"1 - Sword | 2 - Bow | 3 - Scythe"})}),"multiplayer"===x&&(0,l.jsx)("div",{className:"mt-2 text-blue-400",children:(0,l.jsx)("div",{children:"Multiplayer Mode - Cooperative"})}),"pvp"===x&&(0,l.jsx)("div",{className:"mt-2 text-red-400",children:(0,l.jsx)("div",{children:"PVP Mode - Player vs Player"})})]}),(0,l.jsxs)("div",{className:"absolute top-4 right-4 text-white font-mono text-sm",children:[(0,l.jsx)("div",{id:"fps-counter",children:"FPS: --"}),"multiplayer"===x&&(0,l.jsx)("div",{className:"mt-2 text-blue-400",children:(0,l.jsx)("div",{children:"Multiplayer Mode"})}),"pvp"===x&&(0,l.jsx)("div",{className:"mt-2 text-red-400",children:(0,l.jsx)("div",{children:"PVP Mode"})})]}),e.length>0&&a.camera&&a.size&&(0,l.jsx)("div",{className:"absolute inset-0 pointer-events-none",children:(0,l.jsx)(s.Z,{damageNumbers:e,onDamageNumberComplete:j,camera:a.camera,size:a.size})}),(0,l.jsx)("div",{className:"absolute bottom-4 left-4",children:(0,l.jsx)(i.Z,{currentWeapon:h.currentWeapon,playerHealth:h.playerHealth,maxHealth:h.maxHealth,playerShield:h.playerShield,maxShield:h.maxShield,controlSystem:b})})]})]})})}},946:function(e,t,a){"use strict";a.d(t,{P:function(){return d},p:function(){return i}});var l=a(7437),n=a(2265),r=a(8680),o=a(257);let s=(0,n.createContext)(null);function i(){let e=(0,n.useContext)(s);if(!e)throw Error("useMultiplayer must be used within a MultiplayerProvider");return e}function d(e){let{children:t}=e,[a,i]=(0,n.useState)(null),[d,u]=(0,n.useState)(!1),[c,m]=(0,n.useState)(null),[p,h]=(0,n.useState)(!1),[y,b]=(0,n.useState)(null),[w,x]=(0,n.useState)(new Map),[g,v]=(0,n.useState)(new Map),[f,C]=(0,n.useState)(new Map),[D,j]=(0,n.useState)(0),[S,k]=(0,n.useState)(!1),[M,I]=(0,n.useState)("multiplayer"),[N,P]=(0,n.useState)(null),E=(0,n.useRef)(null);(0,n.useEffect)(()=>{let e=o.env.NEXT_PUBLIC_BACKEND_URL||"https://avernus-backend.fly.dev";console.log("\uD83D\uDD0C Connecting to multiplayer server:",e);let t=(0,r.io)(e,{transports:["websocket","polling"],timeout:1e4,forceNew:!0});return t.on("connect",()=>{console.log("✅ Connected to multiplayer server"),u(!0),m(null),E.current&&clearInterval(E.current),E.current=setInterval(()=>{t.emit("heartbeat")},3e4)}),t.on("disconnect",e=>{console.log("❌ Disconnected from server:",e),u(!1),h(!1),b(null),x(new Map),v(new Map),C(new Map),E.current&&(clearInterval(E.current),E.current=null)}),t.on("connect_error",e=>{console.error("\uD83D\uDD25 Connection error:",e),m(e.message),u(!1)}),t.on("room-joined",e=>{console.log("\uD83C\uDFE0 Joined room:",e),h(!0),b(e.roomId),j(e.killCount),k(e.gameStarted),I(e.gameMode||"multiplayer");let t=new Map;if(e.players.forEach(e=>{t.set(e.id,e)}),x(t),"pvp"!==e.gameMode){let t=new Map;e.enemies.forEach(e=>{t.set(e.id,e)}),v(t),C(new Map)}else{v(new Map);let t=new Map;e.towers&&e.towers.forEach(e=>{t.set(e.id,e)}),C(t)}}),t.on("room-full",()=>{m("Room is full (max 5 players)")}),t.on("player-joined",e=>{console.log("\uD83D\uDC64 Player joined:",e);let t=new Map;e.players.forEach(e=>{t.set(e.id,e)}),x(t)}),t.on("player-left",e=>{console.log("\uD83D\uDC4B Player left:",e);let t=new Map;e.players.forEach(e=>{t.set(e.id,e)}),x(t)}),t.on("player-moved",e=>{x(t=>{let a=new Map(t),l=a.get(e.playerId);return l&&a.set(e.playerId,{...l,position:e.position,rotation:e.rotation,movementDirection:e.movementDirection}),a})}),t.on("player-weapon-changed",e=>{x(t=>{let a=new Map(t),l=a.get(e.playerId);return l&&a.set(e.playerId,{...l,weapon:e.weapon,subclass:e.subclass}),a})}),t.on("player-health-updated",e=>{x(t=>{let a=new Map(t),l=a.get(e.playerId);return l&&a.set(e.playerId,{...l,health:e.health,maxHealth:e.maxHealth}),a})}),t.on("enemy-spawned",e=>{I(t=>("pvp"===t||v(t=>{let a=new Map(t);return a.set(e.enemy.id,e.enemy),a}),t))}),t.on("enemy-damaged",e=>{I(t=>("pvp"===t||v(t=>{let a=new Map(t),l=a.get(e.enemyId);return l&&a.set(e.enemyId,{...l,health:e.newHealth,isDying:e.wasKilled}),a}),t))}),t.on("enemy-moved",e=>{I(t=>("pvp"===t||v(t=>{let a=new Map(t),l=a.get(e.enemyId);return l&&a.set(e.enemyId,{...l,position:e.position,rotation:e.rotation}),a}),t))}),t.on("kill-count-updated",e=>{j(e.killCount)}),t.on("game-started",e=>{k(!0),j(e.killCount)}),t.on("room-preview",e=>{P(e)}),t.on("player-attack",e=>{}),t.on("player-used-ability",e=>{}),t.on("player-effect",e=>{}),t.on("player-animation-state",e=>{}),t.on("tower-spawned",e=>{C(t=>{let a=new Map(t);return a.set(e.tower.id,e.tower),a})}),t.on("tower-damaged",e=>{C(t=>{let a=new Map(t),l=a.get(e.towerId);return l&&a.set(e.towerId,{...l,health:e.newHealth,isDead:e.wasDestroyed}),a})}),t.on("tower-destroyed",e=>{C(t=>{let a=new Map(t),l=a.get(e.towerId);return l&&a.set(e.towerId,{...l,health:0,isDead:!0}),a})}),i(t),()=>{E.current&&clearInterval(E.current),t.close()}},[]);let U=(0,n.useCallback)(async function(e,t,l,n){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"multiplayer";if(!a||!d)throw Error("Not connected to server");return new Promise((o,s)=>{let i=setTimeout(()=>{s(Error("Join room timeout"))},1e4);a.once("room-joined",()=>{clearTimeout(i),o()}),a.once("room-full",()=>{clearTimeout(i),s(Error("Room is full"))}),a.emit("join-room",{roomId:e,playerName:t,weapon:l,subclass:n,gameMode:r})})},[a,d]),H=(0,n.useCallback)(()=>{a&&(a.emit("leave-room"),h(!1),b(null),x(new Map),v(new Map),C(new Map),j(0),k(!1),I("multiplayer"))},[a]),_=(0,n.useCallback)(e=>{a&&d&&a.emit("preview-room",{roomId:e})},[a,d]),A=(0,n.useCallback)(()=>{P(null)},[]),G=(0,n.useCallback)(()=>{a&&y&&a.emit("start-game",{roomId:y})},[a,y]),W=(0,n.useCallback)((e,t,l)=>{a&&y&&a.emit("player-update",{roomId:y,position:e,rotation:t,movementDirection:l})},[a,y]),B=(0,n.useCallback)((e,t)=>{a&&y&&a.emit("weapon-changed",{roomId:y,weapon:e,subclass:t})},[a,y]),L=(0,n.useCallback)((e,t)=>{a&&y&&a.emit("player-health-changed",{roomId:y,health:e,maxHealth:t})},[a,y]),R=(0,n.useCallback)((e,t,l,n)=>{a&&y&&a.emit("player-attack",{roomId:y,attackType:e,position:t,direction:l,animationData:n})},[a,y]),z=(0,n.useCallback)((e,t,l,n)=>{console.log("\uD83D\uDD0D DEBUG: broadcastPlayerAbility called with:",{abilityType:e,position:t,direction:l,target:n,hasSocket:!!a,roomId:y}),a&&y?a.emit("player-ability",{roomId:y,abilityType:e,position:t,direction:l,target:n}):console.log("\uD83D\uDD0D DEBUG: Cannot broadcast - missing socket or roomId")},[a,y]),T=(0,n.useCallback)(e=>{a&&y&&a.emit("player-effect",{roomId:y,effect:e})},[a,y]),V=(0,n.useCallback)((e,t)=>{a&&y&&a.emit("enemy-damage",{roomId:y,enemyId:e,damage:t})},[a,y]),F=(0,n.useCallback)((e,t,l)=>{a&&y&&a.emit("apply-status-effect",{roomId:y,enemyId:e,effectType:t,duration:l})},[a,y]),J=(0,n.useCallback)((e,t)=>{a&&y&&a.emit("tower-damage",{roomId:y,towerId:e,damage:t})},[a,y]),Z=(0,n.useCallback)((e,t,l)=>{a&&y&&a.emit("player-damage",{roomId:y,targetPlayerId:e,damage:t,damageType:l})},[a,y]),O=(0,n.useCallback)(e=>{a&&y&&a.emit("player-animation-state",{roomId:y,animationState:e})},[a,y]),K=(0,n.useCallback)((e,t,l,n)=>{a&&y&&a.emit("player-debuff",{roomId:y,targetPlayerId:e,debuffType:t,duration:l,effectData:n,timestamp:Date.now()})},[a,y]);return(0,l.jsx)(s.Provider,{value:{socket:a,isConnected:d,connectionError:c,isInRoom:p,currentRoomId:y,players:w,enemies:g,towers:f,killCount:D,gameStarted:S,gameMode:M,currentPreview:N,joinRoom:U,leaveRoom:H,previewRoom:_,clearPreview:A,startGame:G,updatePlayerPosition:W,updatePlayerWeapon:B,updatePlayerHealth:L,broadcastPlayerAttack:R,broadcastPlayerAbility:z,broadcastPlayerEffect:T,broadcastPlayerDamage:Z,broadcastPlayerAnimationState:O,broadcastPlayerDebuff:K,damageEnemy:V,applyStatusEffect:F,damageTower:J},children:t})}}},function(e){e.O(0,[812,736,971,744],function(){return e(e.s=2607)}),_N_E=e.O()}]);