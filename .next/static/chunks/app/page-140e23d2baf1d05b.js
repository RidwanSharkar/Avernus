(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{2607:function(e,t,a){Promise.resolve().then(a.bind(a,6117))},6117:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return y}});var l=a(7437),n=a(2265),r=a(166),o=a(7125),s=a(4668),i=a(2295),u=a(9640),d=a(946),c=a(4954);let m=(0,r.default)(()=>Promise.all([a.e(841),a.e(736)]).then(a.bind(a,3599)).then(e=>({default:e.Canvas})),{loadableGenerated:{webpack:()=>[3599]},ssr:!1,loading:()=>(0,l.jsx)("div",{className:"flex items-center justify-center h-screen text-white",children:"Loading 3D engine..."})}),p=(0,r.default)(()=>a.e(812).then(a.bind(a,8026)),{loadableGenerated:{webpack:()=>[8026]},ssr:!1,loading:()=>null}),h=(0,r.default)(()=>Promise.all([a.e(841),a.e(893),a.e(812),a.e(736),a.e(552)]).then(a.bind(a,7809)).then(e=>({default:e.PVPGameScene})),{loadableGenerated:{webpack:()=>[7809]},ssr:!1,loading:()=>null});function y(){let[e,t]=(0,n.useState)([]),[a,r]=(0,n.useState)({camera:null,size:{width:0,height:0}}),[y,b]=(0,n.useState)({playerHealth:200,maxHealth:200,playerShield:100,maxShield:100,currentWeapon:o.v.BOW,currentSubclass:o.p.ELEMENTAL,mana:150,maxMana:150}),[x,w]=(0,n.useState)(null),[g,f]=(0,n.useState)("menu"),[v,C]=(0,n.useState)(!1),[D,S]=(0,n.useState)("multiplayer"),[k,M]=(0,n.useState)(0),[I,j]=(0,n.useState)(1),N=e=>{window.handleDamageNumberComplete&&window.handleDamageNumberComplete(e)},E=(e,t)=>{r({camera:e,size:t})},P=e=>{var t,a;b({...e,mana:null!==(t=e.mana)&&void 0!==t?t:150,maxMana:null!==(a=e.maxMana)&&void 0!==a?a:150})},U=e=>{w(e)};return(0,l.jsx)(d.P,{children:(0,l.jsxs)("main",{className:"w-full h-screen bg-black relative",children:["menu"===g&&(0,l.jsx)("div",{className:"absolute inset-0 flex items-center justify-center z-50",children:(0,l.jsxs)("div",{className:"bg-black/95 p-8 rounded-xl border-2 border-green-500 text-white text-center",children:[(0,l.jsx)("h1",{className:"text-4xl font-bold mb-8 text-green-500",children:"AVERNUS"}),(0,l.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,l.jsx)("button",{className:"px-8 py-4 text-xl bg-green-500 text-white border-none rounded-lg cursor-pointer transition-all duration-300 font-bold hover:bg-green-600 hover:-translate-y-1",onClick:()=>f("singleplayer"),children:"Single Player"}),(0,l.jsx)("button",{className:"px-8 py-4 text-xl bg-red-500 text-white border-none rounded-lg cursor-pointer transition-all duration-300 font-bold hover:bg-red-600 hover:-translate-y-1",onClick:()=>{S("pvp"),C(!0)},children:"PVP"})]})]})}),v&&(0,l.jsx)(c.Z,{onJoinSuccess:()=>{C(!1),f(D)},currentWeapon:y.currentWeapon,currentSubclass:y.currentSubclass,gameMode:D}),(0,l.jsxs)(m,{camera:{position:[0,5,10],fov:75,near:.1,far:1e3},shadows:!0,gl:{antialias:!0,alpha:!1,powerPreference:"high-performance"},children:["singleplayer"===g&&(0,l.jsx)(p,{onDamageNumbersUpdate:t,onDamageNumberComplete:N,onCameraUpdate:E,onGameStateUpdate:P,onControlSystemUpdate:U}),"pvp"===g&&(0,l.jsx)(h,{onDamageNumbersUpdate:t,onDamageNumberComplete:N,onCameraUpdate:E,onGameStateUpdate:P,onControlSystemUpdate:U,onExperienceUpdate:(e,t)=>{M(e),j(t)}})]}),"menu"!==g&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"absolute top-4 left-4 text-white font-mono text-sm",children:[(0,l.jsx)("div",{children:"WASD - Double Tap Dash"}),(0,l.jsx)("div",{children:"Right Click - Camera "}),(0,l.jsx)("div",{children:"Left Click - Attack "}),(0,l.jsx)("div",{children:"Space - Jump"})]}),(0,l.jsxs)("div",{className:"absolute top-4 right-4 text-white font-mono text-sm",children:[(0,l.jsx)("div",{id:"fps-counter",children:"FPS: --"}),"multiplayer"===g&&(0,l.jsx)("div",{className:"mt-2 text-blue-400",children:(0,l.jsx)("div",{children:"Multiplayer Mode"})}),"pvp"===g&&(0,l.jsx)("div",{className:"mt-2 text-red-400",children:(0,l.jsx)("div",{children:"PVP Mode"})})]}),e.length>0&&a.camera&&a.size&&(0,l.jsx)("div",{className:"absolute inset-0 pointer-events-none",children:(0,l.jsx)(s.Z,{damageNumbers:e,onDamageNumberComplete:N,camera:a.camera,size:a.size})}),(0,l.jsx)("div",{className:"absolute bottom-4 left-4",children:(0,l.jsx)(i.Z,{currentWeapon:y.currentWeapon,playerHealth:y.playerHealth,maxHealth:y.maxHealth,playerShield:y.playerShield,maxShield:y.maxShield,mana:y.mana||150,maxMana:y.maxMana||150,controlSystem:x})}),"pvp"===g&&(0,l.jsx)(u.Z,{experience:k,level:I,isLocalPlayer:!0})]})]})})}},946:function(e,t,a){"use strict";a.d(t,{P:function(){return u},p:function(){return i}});var l=a(7437),n=a(2265),r=a(8680),o=a(257);let s=(0,n.createContext)(null);function i(){let e=(0,n.useContext)(s);if(!e)throw Error("useMultiplayer must be used within a MultiplayerProvider");return e}function u(e){let{children:t}=e,[a,i]=(0,n.useState)(null),[u,d]=(0,n.useState)(!1),[c,m]=(0,n.useState)(null),[p,h]=(0,n.useState)(!1),[y,b]=(0,n.useState)(null),[x,w]=(0,n.useState)(new Map),[g,f]=(0,n.useState)(new Map),[v,C]=(0,n.useState)(new Map),[D,S]=(0,n.useState)(0),[k,M]=(0,n.useState)(!1),[I,j]=(0,n.useState)("multiplayer"),[N,E]=(0,n.useState)(null),P=(0,n.useRef)(null);(0,n.useEffect)(()=>{let e=o.env.NEXT_PUBLIC_BACKEND_URL||"https://avernus-backend.fly.dev";console.log("\uD83D\uDD0C Connecting to multiplayer server:",e);let t=(0,r.io)(e,{transports:["websocket","polling"],timeout:1e4,forceNew:!0});return t.on("connect",()=>{console.log("✅ Connected to multiplayer server"),d(!0),m(null),P.current&&clearInterval(P.current),P.current=setInterval(()=>{t.emit("heartbeat")},3e4)}),t.on("disconnect",e=>{console.log("❌ Disconnected from server:",e),d(!1),h(!1),b(null),w(new Map),f(new Map),C(new Map),P.current&&(clearInterval(P.current),P.current=null)}),t.on("connect_error",e=>{console.error("\uD83D\uDD25 Connection error:",e),m(e.message),d(!1)}),t.on("room-joined",e=>{console.log("\uD83C\uDFE0 Joined room:",e),h(!0),b(e.roomId),S(e.killCount),M(e.gameStarted),j(e.gameMode||"multiplayer");let t=new Map;if(e.players.forEach(e=>{t.set(e.id,e)}),w(t),"pvp"!==e.gameMode){let t=new Map;e.enemies.forEach(e=>{t.set(e.id,e)}),f(t),C(new Map)}else{f(new Map);let t=new Map;e.towers&&e.towers.forEach(e=>{t.set(e.id,e)}),C(t)}}),t.on("room-full",()=>{m("Room is full (max 5 players)")}),t.on("player-joined",e=>{console.log("\uD83D\uDC64 Player joined:",e);let t=new Map;e.players.forEach(e=>{t.set(e.id,e)}),w(t)}),t.on("player-left",e=>{console.log("\uD83D\uDC4B Player left:",e);let t=new Map;e.players.forEach(e=>{t.set(e.id,e)}),w(t)}),t.on("player-moved",e=>{w(t=>{let a=new Map(t),l=a.get(e.playerId);return l&&a.set(e.playerId,{...l,position:e.position,rotation:e.rotation,movementDirection:e.movementDirection}),a})}),t.on("player-weapon-changed",e=>{w(t=>{let a=new Map(t),l=a.get(e.playerId);return l&&a.set(e.playerId,{...l,weapon:e.weapon,subclass:e.subclass}),a})}),t.on("player-health-updated",e=>{w(t=>{let a=new Map(t),l=a.get(e.playerId);return l&&a.set(e.playerId,{...l,health:e.health,maxHealth:e.maxHealth}),a})}),t.on("enemy-spawned",e=>{j(t=>("pvp"===t||f(t=>{let a=new Map(t);return a.set(e.enemy.id,e.enemy),a}),t))}),t.on("enemy-damaged",e=>{j(t=>("pvp"===t||f(t=>{let a=new Map(t),l=a.get(e.enemyId);return l&&a.set(e.enemyId,{...l,health:e.newHealth,isDying:e.wasKilled}),a}),t))}),t.on("enemy-moved",e=>{j(t=>("pvp"===t||f(t=>{let a=new Map(t),l=a.get(e.enemyId);return l&&a.set(e.enemyId,{...l,position:e.position,rotation:e.rotation}),a}),t))}),t.on("kill-count-updated",e=>{S(e.killCount)}),t.on("game-started",e=>{M(!0),S(e.killCount)}),t.on("room-preview",e=>{E(e)}),t.on("player-attack",e=>{}),t.on("player-used-ability",e=>{}),t.on("player-effect",e=>{}),t.on("player-animation-state",e=>{}),t.on("tower-spawned",e=>{C(t=>{let a=new Map(t);return a.set(e.tower.id,e.tower),a})}),t.on("tower-damaged",e=>{C(t=>{let a=new Map(t),l=a.get(e.towerId);return l&&a.set(e.towerId,{...l,health:e.newHealth,isDead:e.wasDestroyed}),a})}),t.on("tower-destroyed",e=>{C(t=>{let a=new Map(t),l=a.get(e.towerId);return l&&a.set(e.towerId,{...l,health:0,isDead:!0}),a})}),t.on("player-experience-updated",e=>{w(t=>{let a=new Map(t),l=a.get(e.playerId);return l&&a.set(e.playerId,{...l,experience:e.experience,level:e.level}),a})}),i(t),()=>{P.current&&clearInterval(P.current),t.close()}},[]);let U=(0,n.useCallback)(async function(e,t,l,n){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"multiplayer";if(!a||!u)throw Error("Not connected to server");return new Promise((o,s)=>{let i=setTimeout(()=>{s(Error("Join room timeout"))},1e4);a.once("room-joined",()=>{clearTimeout(i),o()}),a.once("room-full",()=>{clearTimeout(i),s(Error("Room is full"))}),a.emit("join-room",{roomId:e,playerName:t,weapon:l,subclass:n,gameMode:r})})},[a,u]),H=(0,n.useCallback)(()=>{a&&(a.emit("leave-room"),h(!1),b(null),w(new Map),f(new Map),C(new Map),S(0),M(!1),j("multiplayer"))},[a]),_=(0,n.useCallback)(e=>{a&&u&&a.emit("preview-room",{roomId:e})},[a,u]),G=(0,n.useCallback)(()=>{E(null)},[]),L=(0,n.useCallback)(()=>{a&&y&&a.emit("start-game",{roomId:y})},[a,y]),W=(0,n.useCallback)((e,t,l)=>{a&&y&&a.emit("player-update",{roomId:y,position:e,rotation:t,movementDirection:l})},[a,y]),A=(0,n.useCallback)((e,t)=>{a&&y&&a.emit("weapon-changed",{roomId:y,weapon:e,subclass:t})},[a,y]),B=(0,n.useCallback)((e,t)=>{a&&y&&a.emit("player-health-changed",{roomId:y,health:e,maxHealth:t})},[a,y]),R=(0,n.useCallback)((e,t,l,n)=>{a&&y&&a.emit("player-attack",{roomId:y,attackType:e,position:t,direction:l,animationData:n})},[a,y]),T=(0,n.useCallback)((e,t,l,n)=>{console.log("\uD83D\uDD0D DEBUG: broadcastPlayerAbility called with:",{abilityType:e,position:t,direction:l,target:n,hasSocket:!!a,roomId:y}),a&&y?a.emit("player-ability",{roomId:y,abilityType:e,position:t,direction:l,target:n}):console.log("\uD83D\uDD0D DEBUG: Cannot broadcast - missing socket or roomId")},[a,y]),z=(0,n.useCallback)(e=>{a&&y&&a.emit("player-effect",{roomId:y,effect:e})},[a,y]),J=(0,n.useCallback)((e,t)=>{a&&y&&a.emit("enemy-damage",{roomId:y,enemyId:e,damage:t})},[a,y]),V=(0,n.useCallback)((e,t,l)=>{a&&y&&a.emit("apply-status-effect",{roomId:y,enemyId:e,effectType:t,duration:l})},[a,y]),Z=(0,n.useCallback)((e,t)=>{a&&y&&a.emit("tower-damage",{roomId:y,towerId:e,damage:t})},[a,y]),F=(0,n.useCallback)((e,t,l)=>{a&&y&&a.emit("player-damage",{roomId:y,targetPlayerId:e,damage:t,damageType:l})},[a,y]),O=(0,n.useCallback)(e=>{a&&y&&a.emit("player-animation-state",{roomId:y,animationState:e})},[a,y]),K=(0,n.useCallback)((e,t,l,n)=>{a&&y&&a.emit("player-debuff",{roomId:y,targetPlayerId:e,debuffType:t,duration:l,effectData:n,timestamp:Date.now()})},[a,y]),X=(0,n.useCallback)((e,t)=>{a&&y&&a.emit("player-experience-changed",{roomId:y,playerId:e,experience:t})},[a,y]),q=(0,n.useCallback)((e,t)=>{a&&y&&a.emit("player-level-changed",{roomId:y,playerId:e,level:t})},[a,y]);return(0,l.jsx)(s.Provider,{value:{socket:a,isConnected:u,connectionError:c,isInRoom:p,currentRoomId:y,players:x,enemies:g,towers:v,killCount:D,gameStarted:k,gameMode:I,currentPreview:N,joinRoom:U,leaveRoom:H,previewRoom:_,clearPreview:G,startGame:L,updatePlayerPosition:W,updatePlayerWeapon:A,updatePlayerHealth:B,broadcastPlayerAttack:R,broadcastPlayerAbility:T,broadcastPlayerEffect:z,broadcastPlayerDamage:F,broadcastPlayerAnimationState:O,broadcastPlayerDebuff:K,damageEnemy:J,applyStatusEffect:V,damageTower:Z,updatePlayerExperience:X,updatePlayerLevel:q},children:t})}}},function(e){e.O(0,[812,736,971,744],function(){return e(e.s=2607)}),_N_E=e.O()}]);